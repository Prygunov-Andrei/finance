services:

  # =========================================================================
  # ИНФРАСТРУКТУРА
  # =========================================================================

  postgres:
    image: postgres:14-alpine
    ports:
      - "5432:5432"
    environment:
      POSTGRES_DB: ${DB_NAME:-finans_assistant}
      POSTGRES_USER: ${DB_USER:-postgres}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-postgres}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-postgres}"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  minio:
    image: minio/minio:latest
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
    volumes:
      - minio_data:/data
    command: server /data --console-address ":9001"
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  createbuckets:
    image: minio/mc:latest
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      /usr/bin/mc alias set myminio http://minio:9000 ${MINIO_ROOT_USER:-minioadmin} ${MINIO_ROOT_PASSWORD:-minioadmin};
      /usr/bin/mc mb myminio/worklog-media --ignore-existing;
      /usr/bin/mc anonymous set download myminio/worklog-media;
      /usr/bin/mc mb myminio/files --ignore-existing;
      exit 0;
      "

  createkanbandb:
    image: postgres:14-alpine
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      PGPASSWORD: ${DB_PASSWORD:-postgres}
      DB_USER: ${DB_USER:-postgres}
      DB_HOST: postgres
      KANBAN_DB_NAME: ${KANBAN_DB_NAME:-kanban}
    entrypoint: >
      /bin/sh -c "
      echo 'Ensuring kanban database exists...';
      psql -h $$DB_HOST -U $$DB_USER -d postgres -tc \"SELECT 1 FROM pg_database WHERE datname='$$KANBAN_DB_NAME'\" | grep -q 1
      || psql -h $$DB_HOST -U $$DB_USER -d postgres -c \"CREATE DATABASE \\\"$$KANBAN_DB_NAME\\\"\" ;
      exit 0;
      "

  # =========================================================================
  # BACKEND (Django + Gunicorn)
  # =========================================================================

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    ports:
      - "8000:8000"
    environment:
      - DEBUG=${DEBUG:-True}
      - SECRET_KEY=${SECRET_KEY:-django-insecure-docker-dev-key-change-in-production}
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_NAME=${DB_NAME:-finans_assistant}
      - DB_USER=${DB_USER:-postgres}
      - DB_PASSWORD=${DB_PASSWORD:-postgres}
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - WORKLOG_S3_ENDPOINT_URL=http://minio:9000
      - WORKLOG_S3_PUBLIC_URL=http://localhost:9000
      - WORKLOG_S3_ACCESS_KEY=${MINIO_ROOT_USER:-minioadmin}
      - WORKLOG_S3_SECRET_KEY=${MINIO_ROOT_PASSWORD:-minioadmin}
      - WORKLOG_S3_BUCKET_NAME=worklog-media
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - ELEVENLABS_API_KEY=${ELEVENLABS_API_KEY}
      - SENTRY_DSN=${SENTRY_DSN}
      - SENTRY_ENVIRONMENT=${SENTRY_ENVIRONMENT:-development}
      - ERP_SERVICE_TOKEN=${ERP_SERVICE_TOKEN:-}
    volumes:
      - backend_media:/app/media
      - backend_logs:/app/logs
      - backend_static:/app/staticfiles
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/api/v1/')"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 30s
    restart: unless-stopped

  kanban-api:
    build:
      context: ./backend
      dockerfile: Dockerfile
    command: ["gunicorn", "kanban_service.wsgi:application", "--bind", "0.0.0.0:8010", "--workers", "2", "--timeout", "120", "--access-logfile", "-", "--error-logfile", "-"]
    ports:
      - "8010:8010"
    environment:
      - KANBAN_DEBUG=${KANBAN_DEBUG:-True}
      - KANBAN_SECRET_KEY=${KANBAN_SECRET_KEY:-django-insecure-kanban-dev-key}
      - KANBAN_DB_HOST=postgres
      - KANBAN_DB_PORT=5432
      - KANBAN_DB_NAME=${KANBAN_DB_NAME:-kanban}
      - KANBAN_DB_USER=${DB_USER:-postgres}
      - KANBAN_DB_PASSWORD=${DB_PASSWORD:-postgres}
      - KANBAN_CELERY_BROKER_URL=redis://redis:6379/1
      - KANBAN_CELERY_RESULT_BACKEND=redis://redis:6379/1
      - KANBAN_S3_ENDPOINT_URL=http://minio:9000
      - KANBAN_S3_ACCESS_KEY=${MINIO_ROOT_USER:-minioadmin}
      - KANBAN_S3_SECRET_KEY=${MINIO_ROOT_PASSWORD:-minioadmin}
      - KANBAN_S3_BUCKET_NAME=files
      - ERP_API_BASE_URL=http://backend:8000/api/v1
      - ERP_SERVICE_TOKEN=${ERP_SERVICE_TOKEN:-}
    depends_on:
      createkanbandb:
        condition: service_completed_successfully
      redis:
        condition: service_healthy
    restart: unless-stopped

  kanban-celery-worker:
    build:
      context: ./backend
      dockerfile: Dockerfile
    command: celery -A kanban_service worker --loglevel=info --concurrency=2
    environment:
      - KANBAN_DEBUG=${KANBAN_DEBUG:-True}
      - KANBAN_SECRET_KEY=${KANBAN_SECRET_KEY:-django-insecure-kanban-dev-key}
      - KANBAN_DB_HOST=postgres
      - KANBAN_DB_PORT=5432
      - KANBAN_DB_NAME=${KANBAN_DB_NAME:-kanban}
      - KANBAN_DB_USER=${DB_USER:-postgres}
      - KANBAN_DB_PASSWORD=${DB_PASSWORD:-postgres}
      - KANBAN_CELERY_BROKER_URL=redis://redis:6379/1
      - KANBAN_CELERY_RESULT_BACKEND=redis://redis:6379/1
      - KANBAN_S3_ENDPOINT_URL=http://minio:9000
      - KANBAN_S3_ACCESS_KEY=${MINIO_ROOT_USER:-minioadmin}
      - KANBAN_S3_SECRET_KEY=${MINIO_ROOT_PASSWORD:-minioadmin}
      - KANBAN_S3_BUCKET_NAME=files
      - ERP_API_BASE_URL=http://backend:8000/api/v1
      - ERP_SERVICE_TOKEN=${ERP_SERVICE_TOKEN:-}
    depends_on:
      createkanbandb:
        condition: service_completed_successfully
      redis:
        condition: service_healthy
    restart: unless-stopped

  kanban-celery-beat:
    build:
      context: ./backend
      dockerfile: Dockerfile
    command: celery -A kanban_service beat --loglevel=info
    environment:
      - KANBAN_DEBUG=${KANBAN_DEBUG:-True}
      - KANBAN_SECRET_KEY=${KANBAN_SECRET_KEY:-django-insecure-kanban-dev-key}
      - KANBAN_DB_HOST=postgres
      - KANBAN_DB_PORT=5432
      - KANBAN_DB_NAME=${KANBAN_DB_NAME:-kanban}
      - KANBAN_DB_USER=${DB_USER:-postgres}
      - KANBAN_DB_PASSWORD=${DB_PASSWORD:-postgres}
      - KANBAN_CELERY_BROKER_URL=redis://redis:6379/1
      - KANBAN_CELERY_RESULT_BACKEND=redis://redis:6379/1
      - KANBAN_S3_ENDPOINT_URL=http://minio:9000
      - KANBAN_S3_ACCESS_KEY=${MINIO_ROOT_USER:-minioadmin}
      - KANBAN_S3_SECRET_KEY=${MINIO_ROOT_PASSWORD:-minioadmin}
      - KANBAN_S3_BUCKET_NAME=files
      - ERP_API_BASE_URL=http://backend:8000/api/v1
      - ERP_SERVICE_TOKEN=${ERP_SERVICE_TOKEN:-}
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped

  # =========================================================================
  # CELERY WORKER
  # =========================================================================

  celery-worker:
    build:
      context: ./backend
      dockerfile: Dockerfile
    command: celery -A finans_assistant worker --loglevel=info --concurrency=2
    environment:
      - DEBUG=${DEBUG:-True}
      - SECRET_KEY=${SECRET_KEY:-django-insecure-docker-dev-key-change-in-production}
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_NAME=${DB_NAME:-finans_assistant}
      - DB_USER=${DB_USER:-postgres}
      - DB_PASSWORD=${DB_PASSWORD:-postgres}
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - WORKLOG_S3_ENDPOINT_URL=http://minio:9000
      - WORKLOG_S3_PUBLIC_URL=http://localhost:9000
      - WORKLOG_S3_ACCESS_KEY=${MINIO_ROOT_USER:-minioadmin}
      - WORKLOG_S3_SECRET_KEY=${MINIO_ROOT_PASSWORD:-minioadmin}
      - WORKLOG_S3_BUCKET_NAME=worklog-media
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - ELEVENLABS_API_KEY=${ELEVENLABS_API_KEY}
      - SENTRY_DSN=${SENTRY_DSN}
    volumes:
      - backend_logs:/app/logs
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped

  # =========================================================================
  # CELERY BEAT (планировщик)
  # =========================================================================

  celery-beat:
    build:
      context: ./backend
      dockerfile: Dockerfile
    command: celery -A finans_assistant beat --loglevel=info
    environment:
      - DEBUG=${DEBUG:-True}
      - SECRET_KEY=${SECRET_KEY:-django-insecure-docker-dev-key-change-in-production}
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_NAME=${DB_NAME:-finans_assistant}
      - DB_USER=${DB_USER:-postgres}
      - DB_PASSWORD=${DB_PASSWORD:-postgres}
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped

  # =========================================================================
  # TELEGRAM BOT
  # =========================================================================

  bot:
    build:
      context: ./bot
      dockerfile: Dockerfile
    ports:
      - "8081:8081"
    environment:
      - BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - WEBHOOK_URL=${BOT_WEBHOOK_URL:-}
      - WEBHOOK_PATH=/bot/webhook
      - WEBAPP_HOST=0.0.0.0
      - WEBAPP_PORT=8081
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_NAME=${DB_NAME:-finans_assistant}
      - DB_USER=${DB_USER:-postgres}
      - DB_PASSWORD=${DB_PASSWORD:-postgres}
      - REDIS_URL=redis://redis:6379/0
      - MINI_APP_URL=${MINI_APP_URL:-}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped

  # =========================================================================
  # ERP FRONTEND (React + nginx)
  # =========================================================================

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    depends_on:
      - backend
    restart: unless-stopped

  # =========================================================================
  # TELEGRAM MINI APP (React + nginx)
  # =========================================================================

  mini-app:
    build:
      context: ./mini-app
      dockerfile: Dockerfile
    ports:
      - "3001:3001"
    depends_on:
      - backend
    restart: unless-stopped

volumes:
  postgres_data:
  redis_data:
  minio_data:
  backend_media:
  backend_logs:
  backend_static:
