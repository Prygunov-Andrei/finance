services:

  # =========================================================================
  # ИНФРАСТРУКТУРА
  # =========================================================================

  postgres:
    image: postgres:14-alpine
    # PRODUCTION: Убран проброс портов наружу для безопасности
    environment:
      POSTGRES_DB: ${DB_NAME}
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      # Production tuning
      POSTGRES_SHARED_BUFFERS: 256MB
      POSTGRES_MAX_CONNECTIONS: 100
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER}"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: always
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  redis:
    image: redis:7-alpine
    # PRODUCTION: Убран проброс портов наружу
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: always
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  minio:
    image: minio/minio:latest
    # PRODUCTION: Убран проброс портов наружу (доступ через nginx)
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
    volumes:
      - minio_data:/data
    command: server /data --console-address ":9001"
    healthcheck:
      test: ["CMD-SHELL", "test -d /data"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: always
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  createbuckets:
    image: minio/mc:latest
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      /usr/bin/mc alias set myminio http://minio:9000 ${MINIO_ROOT_USER} ${MINIO_ROOT_PASSWORD};
      /usr/bin/mc mb myminio/worklog-media --ignore-existing;
      /usr/bin/mc anonymous set download myminio/worklog-media;
      exit 0;
      "

  # =========================================================================
  # BACKEND (Django + Gunicorn)
  # =========================================================================

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    # PRODUCTION: Порты пробрасываются для nginx на хосте
    ports:
      - "127.0.0.1:8000:8000"
    environment:
      - DEBUG=${DEBUG:-False}
      - SECRET_KEY=${SECRET_KEY}
      - BANK_ENCRYPTION_KEY=${BANK_ENCRYPTION_KEY:-}
      - PRODUCTION_DOMAIN=${PRODUCTION_DOMAIN:-}
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_NAME=${DB_NAME}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - WORKLOG_S3_ENDPOINT_URL=http://minio:9000
      - WORKLOG_S3_PUBLIC_URL=${PUBLIC_BACKEND_URL}/media
      - WORKLOG_S3_ACCESS_KEY=${MINIO_ROOT_USER}
      - WORKLOG_S3_SECRET_KEY=${MINIO_ROOT_PASSWORD}
      - WORKLOG_S3_BUCKET_NAME=worklog-media
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - ELEVENLABS_API_KEY=${ELEVENLABS_API_KEY}
      - FNS_API_KEY=${FNS_API_KEY:-}
      - SENTRY_DSN=${SENTRY_DSN}
      - SENTRY_ENVIRONMENT=${SENTRY_ENVIRONMENT:-production}
    volumes:
      - backend_media:/app/media
      - backend_logs:/app/logs
      - backend_static:/app/staticfiles
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import sys, urllib.request, urllib.error; url='http://localhost:8000/api/v1/';\ntry:\n urllib.request.urlopen(url); sys.exit(0)\nexcept urllib.error.HTTPError as e:\n sys.exit(0 if e.code in (200,401,403) else 1)\nexcept Exception:\n sys.exit(1)",
        ]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 30s
    restart: always
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # =========================================================================
  # CELERY WORKER
  # =========================================================================

  celery-worker:
    build:
      context: ./backend
      dockerfile: Dockerfile
    command: celery -A finans_assistant worker --loglevel=info --concurrency=2
    environment:
      - DEBUG=${DEBUG:-False}
      - SECRET_KEY=${SECRET_KEY}
      - BANK_ENCRYPTION_KEY=${BANK_ENCRYPTION_KEY:-}
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_NAME=${DB_NAME}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - WORKLOG_S3_ENDPOINT_URL=http://minio:9000
      - WORKLOG_S3_PUBLIC_URL=${PUBLIC_BACKEND_URL}/media
      - WORKLOG_S3_ACCESS_KEY=${MINIO_ROOT_USER}
      - WORKLOG_S3_SECRET_KEY=${MINIO_ROOT_PASSWORD}
      - WORKLOG_S3_BUCKET_NAME=worklog-media
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - ELEVENLABS_API_KEY=${ELEVENLABS_API_KEY}
      - FNS_API_KEY=${FNS_API_KEY:-}
      - SENTRY_DSN=${SENTRY_DSN}
      - SENTRY_ENVIRONMENT=${SENTRY_ENVIRONMENT:-production}
    volumes:
      - backend_logs:/app/logs
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: always
    deploy:
      resources:
        limits:
          cpus: '1.5'
          memory: 1.5G
        reservations:
          cpus: '0.5'
          memory: 512M
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # =========================================================================
  # CELERY BEAT (планировщик)
  # =========================================================================

  celery-beat:
    build:
      context: ./backend
      dockerfile: Dockerfile
    command: celery -A finans_assistant beat --loglevel=info
    environment:
      - DEBUG=${DEBUG:-False}
      - SECRET_KEY=${SECRET_KEY}
      - BANK_ENCRYPTION_KEY=${BANK_ENCRYPTION_KEY:-}
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_NAME=${DB_NAME}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
    depends_on:
      redis:
        condition: service_healthy
    restart: always
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 128M
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # =========================================================================
  # TELEGRAM BOT
  # =========================================================================

  bot:
    build:
      context: ./bot
      dockerfile: Dockerfile
    command: ["python", "main.py", "--webhook"]
    # PRODUCTION: Порты пробрасываются для nginx на хосте
    ports:
      - "127.0.0.1:8081:8081"
    environment:
      - BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - WEBHOOK_URL=${BOT_WEBHOOK_URL}
      - WEBHOOK_PATH=/bot/webhook
      - WEBAPP_HOST=0.0.0.0
      - WEBAPP_PORT=8081
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_NAME=${DB_NAME}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - REDIS_URL=redis://redis:6379/0
      - MINI_APP_URL=${MINI_APP_URL}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: always
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # =========================================================================
  # ERP FRONTEND (React + nginx)
  # =========================================================================

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    # PRODUCTION: Порты пробрасываются для nginx на хосте
    ports:
      - "127.0.0.1:3000:3000"
    depends_on:
      - backend
    restart: always
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 128M
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # =========================================================================
  # TELEGRAM MINI APP (React + nginx)
  # =========================================================================

  mini-app:
    build:
      context: ./mini-app
      dockerfile: Dockerfile
    # PRODUCTION: Порты пробрасываются для nginx на хосте
    ports:
      - "127.0.0.1:3001:3001"
    depends_on:
      - backend
    restart: always
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 128M
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  postgres_data:
  redis_data:
  minio_data:
  backend_media:
  backend_logs:
  backend_static:
