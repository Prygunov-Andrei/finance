# Раздел «Финансы» — Руководство пользователя

## Навигация

Раздел «Финансы» доступен в боковом меню и включает:

- **Дашборд Финансы** — сводная панель с ключевыми показателями
- **Платежи** — три вкладки: Счета на оплату, Реестр оплат, Входящие платежи
- **Выписки за период** — выписки из банка
- **Периодические платежи** — настройка регулярных платежей
- **Инструкции** — данная справка

---

## 1. Дашборд Финансы

### Итого средств на счетах и в кассе

Отображает реальные остатки по всем активным банковским счетам и кассе. Данные получаются из банковского сервиса (API Точка) и внутреннего учёта.

Каждый счёт показывает:
- Название счёта
- Номер счёта
- Текущий баланс
- Тип (банковский / касса)

### Заглушки (будут реализованы позднее)

- **Дебиторская задолженность** — итого (подтверждённая / сомнительная), к получению сегодня, по объектам
- **Кредиторская задолженность** — итого (Поставщикам / Монтажникам), к оплате сегодня
- **Прибыль** — валовая / чистая, по объектам, за период
- **Оборотные средства** — в объектах / свободные
- **Отчёты за периоды** — с учётом премий
- **Чистые активы** — общая сумма и динамика
- **Налоги** — НДС по объектам, неоплаченные налоги

---

## 2. Счета на оплату

### Типы счетов

При создании нового счёта необходимо выбрать один из пяти типов:

#### 2.1 От Поставщика

Внешний счёт от поставщика за товары или услуги.

- Привязывается к **Объекту** и **Договору**
- Загружается PDF или изображение счёта
- Система автоматически распознаёт позиции через LLM (можно отключить)
- Распознанные товары сопоставляются с каталогом (сервис ProductMatcher)
- Оригинал документа всегда сохраняется

**Шаги создания:**
1. Выберите тип «От Поставщика»
2. Загрузите файл счёта (PDF или изображение)
3. Укажите Объект и Договор
4. Выберите Контрагента-поставщика
5. При необходимости включите «Пропустить распознавание»
6. Укажите суммы (с НДС, без НДС, НДС)
7. Нажмите «Создать»

#### 2.2 По Акту выполненных работ

Оплата по Акту, ранее созданному для Договора с Исполнителем.

- Привязывается к **Объекту**, **Договору** и **Акту**
- Сумма автоматически подставляется из Акта
- Доступен только в разделе «Финансы»

**Шаги создания:**
1. Выберите тип «По Акту»
2. Укажите Объект, затем Договор (с Исполнителем)
3. Выберите Акт — сумма подставится автоматически
4. При необходимости скорректируйте НДС
5. Нажмите «Создать»

#### 2.3 Хозяйственная деятельность

Платежи за аренду, связь, подписки и другие хозяйственные нужды.

- Привязывается к категории из **Внутреннего плана счетов**
- При оплате автоматически создаётся проводка на счёт «Прибыль»

**Шаги создания:**
1. Выберите тип «Хозяйственная деятельность»
2. Укажите категорию расходов (Аренда, Связь и т.д.)
3. Введите сумму и описание
4. Нажмите «Создать»

#### 2.4 Закупка на склад

Закупка материалов на склад без привязки к конкретному объекту.

- Требуется обязательное распознавание товаров
- Загрузка документа обязательна

#### 2.5 Внутренний перевод

Перевод между счетами Внутреннего плана счетов или между юридическими лицами.

**Примеры:**
- Объект → Прибыль (вывод прибыли с завершённого объекта)
- Прибыль → Оборотные средства (пополнение оборотных)
- Оборотные средства → Объект (финансирование объекта)

### Контроль сальдо

При создании счёта по Объекту система автоматически проверяет баланс виртуального счёта объекта. Если средств недостаточно:

- Отображается предупреждение с текущим балансом и дефицитом
- Платёж не блокируется, но требует внимания
- Рекомендуется пополнить счёт объекта через внутренний перевод из «Оборотных средств»

### НДС

При заполнении суммы с НДС система автоматически рассчитывает:
- Сумму НДС (20% от суммы с НДС)
- Сумму без НДС

Суммы можно скорректировать вручную (например, для округления копеек). Сумма НДС учитывается на отдельном счёте «НДС» во Внутреннем плане счетов.

### Долговой счёт

Любой счёт можно пометить как «Долговой» и указать крайнюю дату оплаты. Такие счета:
- Выделяются в таблице (янтарная граница)
- Подсвечиваются в Реестре оплат при приближении срока

---

## 3. Реестр оплат

Реестр показывает все счета на оплату в табличном виде с информацией для принятия решений.

### Баннер балансов

В верхней части всегда видна компактная сводка по балансам банковских счетов и кассы. Это помогает оценить возможность оплаты.

### Статусы и подсветка

| Статус | Описание |
|---|---|
| В реестре | Ожидает рассмотрения контролёром |
| Согласовано | Контролёр одобрил, формируется платёжное поручение |
| Отправляется | Платёжное поручение отправлено в банк |
| Оплачено | Платёж подтверждён банком |

**Цветовая подсветка:**
- Бледно-жёлтый фон — срок оплаты на этой неделе
- Бледно-красный фон — срок оплаты сегодня или просрочен

### Workflow согласования

1. **Оператор** создаёт счёт → статус «На проверке» или «Распознаётся»
2. **Оператор** подтверждает → статус «В реестре»
3. **Контролёр** просматривает и нажимает «Согласовать»
   - В истории сохраняется: кто и когда согласовал
   - Для безналичного платежа формируется Платёжное поручение (черновик в банке)
4. Банк подтверждает оплату → статус «Оплачено»

**Наличный платёж:**
- После согласования статус меняется вручную кассиром
- Требуется загрузка документа (расписка / подпись получателя)

### Проводки

При оплате любого счёта автоматически создаётся проводка — запись о списании средств с одного счёта Внутреннего плана и зачислении на другой.

---

## 4. Входящие платежи

### Типы поступлений

#### От Заказчиков
- **По Акту** — оплата за выполненные работы (привязка к Объекту, Договору, Акту)
- **Аванс** — предоплата по Договору
- **Возврат гарантийных удержаний** — частичный возврат удержанных средств

#### Прочие
- **Возврат от Поставщика** — возврат за некачественный товар или переплату
- **Проценты банка** — начисление процентов на остаток
- **Другие** — иные поступления

### Автоматическое формирование из выписки

При получении банковской выписки система автоматически формирует список входящих платежей. LLM анализирует назначение платежа и предлагает привязку к Объекту и Договору. Оператор может скорректировать предложенные данные.

*(Данная функция будет реализована позднее)*

### Касса

Наличные поступления учитываются в Кассе:
- Журнал всех наличных операций
- Расчёт текущего остатка в кассе
- Каждая операция с указанием контрагента, суммы и основания

---

## 5. Внутренние проводки

### Что такое проводка

Проводка — запись о перемещении средств между счетами Внутреннего плана счетов. Каждая проводка содержит:
- Дату
- Счёт-источник (дебет)
- Счёт-получатель (кредит)
- Сумму
- Описание

### Примеры проводок

| Операция | Со счёта | На счёт |
|---|---|---|
| Вывод прибыли с объекта | Счёт Объекта | Прибыль |
| Пополнение оборотных | Прибыль | Оборотные средства |
| Финансирование объекта | Оборотные средства | Счёт Объекта |
| Хозяйственный расход | Прибыль | Категория расхода |
| Начисление НДС | Категория расхода | НДС |

### Автоматические проводки

Создаются автоматически при:
- Оплате счёта (Invoice)
- Поступлении средств (IncomeRecord)
- Оплате хозяйственных расходов (двойная проводка)

### Ручные проводки

Для внутренних переводов между счетами используйте:
1. Раздел «Платежи» → тип «Внутренний перевод»
2. Или API: `POST /api/v1/journal-entries/manual/`

---

## 6. Глоссарий

| Термин | Определение |
|---|---|
| **Внутренний план счетов** | Иерархическая структура счетов для учёта движения средств (расходные категории, системные счета, счета объектов и договоров) |
| **Проводка** | Запись о перемещении средств между счетами внутреннего плана |
| **Сальдо** | Текущий баланс счёта (разница входящих и исходящих проводок) |
| **Дебет** | Списание со счёта |
| **Кредит** | Зачисление на счёт |
| **НДС** | Налог на добавленную стоимость (20%), учитывается на отдельном счёте |
| **Касса** | Учёт наличных денежных средств |
| **Платёжное поручение** | Документ для банка на выполнение безналичного платежа |
| **Счёт объекта** | Виртуальный счёт для контроля финансов конкретного строительного объекта |
| **Оборотные средства** | Свободные средства компании для финансирования объектов |
