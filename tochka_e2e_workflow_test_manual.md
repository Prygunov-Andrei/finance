# План тестирования: Полный workflow снабжения

## E2E Тест: От карточки Bitrix24 до платежа в банке

---

## 1. Настройка интеграции Bitrix24

- [ ] 1.1. Создан Outgoing Webhook в Bitrix24 с событием `ONCRMDEALLUPDATE`
- [ ] 1.2. URL обработчика указывает на `/api/v1/supply/webhook/bitrix/`
- [ ] 1.3. Создан Inbound Webhook с правами `crm`, `disk`
- [ ] 1.4. В ERP создана запись BitrixIntegration с корректными параметрами:
  - [ ] Portal URL корректен
  - [ ] Webhook URL корректен
  - [ ] Outgoing Webhook Token совпадает
  - [ ] Target Stage ID соответствует стадии "Передан в Оплату"
  - [ ] Интеграция активна (`is_active = true`)
- [ ] 1.5. В ERP заведены Объекты и Договоры, соответствующие тестовым данным

---

## 2. Приём Webhook от Bitrix24

- [ ] 2.1. Тестовая сделка создана в Bitrix24 с заголовком формата `{номер_договора} {объект} — {описание}. {Поставщик} (сч.{номер})`
- [ ] 2.2. К сделке прикреплён комментарий с файлом запроса (текст содержит "запрос")
- [ ] 2.3. К сделке прикреплён комментарий с PDF счёта
- [ ] 2.4. Сделка перемещена в стадию "Передан в Оплату"
- [ ] 2.5. ERP принял Webhook (HTTP 200)
- [ ] 2.6. Создан `SupplyRequest` со статусом `received`
- [ ] 2.7. Celery-задача `process_bitrix_deal` запущена
- [ ] 2.8. Webhook с неверным токеном отклоняется (HTTP 403)
- [ ] 2.9. Webhook с дублирующим deal_id не создаёт дубликат

---

## 3. Обработка сделки (Celery task)

- [ ] 3.1. Данные сделки получены через API Bitrix24
- [ ] 3.2. Заголовок сделки корректно распарсен:
  - [ ] Номер договора определён
  - [ ] Объект определён
  - [ ] Объект найден в базе ERP
  - [ ] Договор найден в базе ERP
- [ ] 3.3. Комментарии получены из Bitrix24
- [ ] 3.4. Файлы скачаны из комментариев
- [ ] 3.5. Файл запроса идентифицирован (по ключевому слову "запрос")
- [ ] 3.6. Файл(ы) счёта идентифицированы (без ключевого слова "запрос")
- [ ] 3.7. Текстовый запрос (без файла) сохранён в `request_text`
- [ ] 3.8. `SupplyRequest` обновлён со статусом `processing`, затем `completed`
- [ ] 3.9. Для каждого счёта создан `Invoice` со статусом `recognition`
- [ ] 3.10. При ошибке API Bitrix24 — `SupplyRequest` получает статус `error` с описанием

---

## 4. Распознавание счёта (LLM)

- [ ] 4.1. Celery-задача `recognize_invoice` запущена для каждого Invoice
- [ ] 4.2. PDF отправлен в LLM-провайдер
- [ ] 4.3. Результат распознавания содержит:
  - [ ] Номер счёта
  - [ ] Дата счёта
  - [ ] Контрагент (название, ИНН)
  - [ ] Позиции (наименование, кол-во, цена, сумма)
  - [ ] Общая сумма
  - [ ] Сумма НДС (если применимо)
- [ ] 4.4. `InvoiceItem` созданы для каждой позиции
- [ ] 4.5. ProductMatcher вызван для каждой позиции:
  - [ ] Fuzzy matching находит точные совпадения (>90%)
  - [ ] Fuzzy matching находит похожие (70-90%) — отправлено в LLM
  - [ ] Новые товары создаются в каталоге
  - [ ] Дубликаты обнаруживаются через алиасы
- [ ] 4.6. `recognition_confidence` установлен (0.0 - 1.0)
- [ ] 4.7. Invoice переведён в статус `review`
- [ ] 4.8. Уведомление отправлено Оператору-Снабженцу
- [ ] 4.9. При ошибке LLM — Invoice остаётся в `recognition`, ошибка залогирована

---

## 5. Проверка Оператором-Снабженцем

- [ ] 5.1. Оператор видит счёт в списке "Счета на оплату" (фильтр: `review`)
- [ ] 5.2. Детальная страница счёта отображает:
  - [ ] PDF-скан счёта (доступен для просмотра/скачивания)
  - [ ] Распознанные данные (номер, дата, контрагент, сумма)
  - [ ] Позиции с сопоставленными товарами
  - [ ] Уровень уверенности распознавания
  - [ ] Привязку к объекту и договору
- [ ] 5.3. Оператор может редактировать:
  - [ ] Номер счёта и дату
  - [ ] Контрагента
  - [ ] Позиции (количество, цену, товар из каталога)
  - [ ] Объект и договор
  - [ ] Срок оплаты
- [ ] 5.4. Оператор нажимает "В реестр":
  - [ ] Invoice переходит в статус `in_registry`
  - [ ] Создаётся InvoiceEvent "submitted"
  - [ ] Уведомление отправлено Директору-контролёру
- [ ] 5.5. Валидация: невозможно отправить в реестр без обязательных полей (контрагент, счёт, юрлицо)

---

## 6. Дашборд Директора-контролёра

- [ ] 6.1. Дашборд отображает:
  - [ ] Остатки на всех счетах (внутренние и банковские)
  - [ ] Общую сумму счетов в реестре
  - [ ] Количество счетов в реестре
  - [ ] Просроченные счета (сумма и количество)
  - [ ] Счета на сегодня (сумма и количество)
  - [ ] Счета на неделю/месяц
- [ ] 6.2. Разбивка по объектам отображается корректно
- [ ] 6.3. Разбивка по категориям расходов отображается корректно
- [ ] 6.4. Данные обновляются при F5 / pull-to-refresh

---

## 7. Одобрение / Отклонение счёта

### 7.1. Одобрение
- [ ] 7.1.1. Директор нажимает "Одобрить" на счёте в реестре
- [ ] 7.1.2. Invoice переходит в статус `approved`
- [ ] 7.1.3. Создаётся InvoiceEvent "approved" с информацией о пользователе
- [ ] 7.1.4. Зафиксированы `approved_by` и `approved_at`
- [ ] 7.1.5. Уведомление отправлено

### 7.2. Отклонение
- [ ] 7.2.1. Директор нажимает "Отклонить" с обязательным комментарием
- [ ] 7.2.2. Invoice возвращается в статус `review`
- [ ] 7.2.3. Создаётся InvoiceEvent "rejected" с комментарием
- [ ] 7.2.4. Уведомление отправлено Оператору-Снабженцу

### 7.3. Перенос даты
- [ ] 7.3.1. Директор нажимает "Перенести" с новой датой и комментарием
- [ ] 7.3.2. `due_date` обновлён
- [ ] 7.3.3. Invoice остаётся в статусе `in_registry`
- [ ] 7.3.4. Создаётся InvoiceEvent "rescheduled"

---

## 8. Создание платёжного поручения

- [ ] 8.1. После одобрения вызывается `InvoiceService.send_to_bank()`
- [ ] 8.2. Создан `BankPaymentOrder` со статусом `draft`
- [ ] 8.3. Реквизиты получателя заполнены из контрагента
- [ ] 8.4. Сумма и назначение платежа корректны
- [ ] 8.5. НДС-информация включена
- [ ] 8.6. Invoice переведён в статус `sending`
- [ ] 8.7. Invoice связан с BankPaymentOrder через `invoice.bank_payment_order`

---

## 9. Отправка в банк

- [ ] 9.1. BankPaymentOrder отправлен через API банка Точка
- [ ] 9.2. Статус BankPaymentOrder обновлён на `sent_to_bank`
- [ ] 9.3. Получен `external_id` от банка
- [ ] 9.4. При ошибке банка — статус `failed`, ошибка залогирована
- [ ] 9.5. Повторная отправка возможна после исправления ошибки

---

## 10. Подтверждение оплаты

- [ ] 10.1. Банк подтверждает исполнение (callback или polling)
- [ ] 10.2. BankPaymentOrder переведён в статус `executed`
- [ ] 10.3. Invoice переведён в статус `paid`
- [ ] 10.4. `paid_at` зафиксирован
- [ ] 10.5. Уведомление отправлено
- [ ] 10.6. Баланс счёта обновлён (уменьшен на сумму платежа)

---

## 11. Периодические платежи

- [ ] 11.1. Создан `RecurringPayment` (например, аренда)
- [ ] 11.2. Celery Beat генерирует Invoice в назначенный день
- [ ] 11.3. Invoice создаётся со статусом `in_registry`
- [ ] 11.4. Invoice содержит корректные данные из RecurringPayment
- [ ] 11.5. `next_generation_date` обновлён на следующий период
- [ ] 11.6. Деактивация RecurringPayment прекращает генерацию
- [ ] 11.7. RecurringPayment с `end_date` в прошлом не генерирует Invoice

---

## 12. Учёт доходов

- [ ] 12.1. Создана запись IncomeRecord
- [ ] 12.2. Баланс счёта увеличился на сумму дохода
- [ ] 12.3. Доход отображается в списке
- [ ] 12.4. Скан-файл прикреплён

---

## 13. Уведомления

- [ ] 13.1. Уведомления приходят при:
  - [ ] Новый счёт на проверку (для оператора)
  - [ ] Счёт отправлен в реестр (для директора)
  - [ ] Счёт одобрен/отклонён (для оператора)
  - [ ] Платёж исполнен
- [ ] 13.2. Бейдж с количеством непрочитанных отображается в навигации
- [ ] 13.3. Push-уведомления в браузере работают (если разрешены)
- [ ] 13.4. Уведомления можно отметить прочитанными

---

## 14. Edge Cases (Граничные случаи)

- [ ] 14.1. Сделка Bitrix24 без файлов — SupplyRequest создаётся, Invoice не создаётся
- [ ] 14.2. Несколько счетов в одной сделке — создаётся несколько Invoice
- [ ] 14.3. Объект/Договор не найден в ERP — запрос помечен как "проблемный" (`mapping_errors`)
- [ ] 14.4. LLM не смог распознать счёт — Invoice остаётся в `recognition` для ручной обработки
- [ ] 14.5. Дублирующий Webhook (та же сделка) — не создаёт дубликат
- [ ] 14.6. Bitrix24 API недоступен — задача повторяется (retry)
- [ ] 14.7. Банк отклонил платёжное поручение — статус `failed`, можно исправить и повторить
- [ ] 14.8. Отмена счёта на любом этапе — корректная обработка

---

## 15. Производительность

- [ ] 15.1. Webhook обрабатывается менее 200ms (сам endpoint)
- [ ] 15.2. Обработка сделки (Celery) — менее 30 секунд
- [ ] 15.3. Распознавание LLM — менее 60 секунд
- [ ] 15.4. Список счетов загружается менее 1 секунды
- [ ] 15.5. Дашборд загружается менее 2 секунд

---

*Последнее обновление: Февраль 2026*
