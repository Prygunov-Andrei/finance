# Описание проекта и сущностей

## 1. Общее описание проекта

### Контекст
- Строительная компания ведёт несколько объектов (строительные площадки, здания).
- Каждый объект связан с множеством договоров, которые могут исполняться разными юридическими лицами.
- Финансовые операции фиксируются в табличных файлах и сопровождаются документами, размещёнными в общем хранилище.

### Цели системы
- Централизовать финансовые данные по объектам и договорам.
- Автоматизировать сбор, обработку и анализ платежей из загруженных таблиц.
- Обеспечить расчёт cash-flow по каждому объекту и по компании в целом.
- Предоставить прозрачную отчётность и аналитические инструменты для команды.

### Роли пользователей

- **Руководитель строительного направления**
  - Видит сводку по всем объектам, динамику cash-flow, статус договоров.
  - Получает уведомления о рисках (кассовые разрывы, просрочки платежей).

- **Финансовый директор / главный бухгалтер**
  - Контролирует движение средств по договорам.
  - Формирует финансовые отчёты, проверяет корректность платежей и задолженностей.

- **Проектный менеджер объекта**
  - Следит за затратами и поступлениями в разрезе конкретного объекта.
  - Вносит комментарии к платежам, инициирует плановые платежи.

- **Финансовый аналитик**
  - Загружает обновлённые таблицы, сверяет расчёты, формирует прогнозы cash-flow.

### Ключевые требования
1. Система хранит объекты, связанные договоры и платежи.
2. Пользователи могут импортировать актуальные табличные данные без ручного ввода.
3. Cash-flow рассчитывается автоматически в разрезе объектов, договоров и периодов.
4. Доступны отчёты: сводка по объектам, детализация по договорам, реестр плановых платежей, задолженность.
5. Вся информация по платежам должна ссылаться на исходные документы (сканы, PDF).
6. История импортов и изменения данных фиксируются для аудита.

---

## 2. Основные сущности

### Object (Объект)
Физическое место строительства с уникальным названием и адресом.

**Поля:**
- `id` — уникальный идентификатор
- `name` — название объекта (уникальное)
- `address` — адрес объекта
- `description` — описание объекта (опционально)
- `created_at` — дата создания
- `updated_at` — дата обновления

**Связи:**
- Один объект может иметь множество договоров (`contracts`)
- Агрегированные показатели cash-flow

**Методы:**
- `get_cash_flow(start_date=None, end_date=None)` — расчёт cash-flow для объекта
- `get_cash_flow_by_periods(period_type='month', start_date=None, end_date=None)` — расчёт по периодам

### Contract (Договор)
Финансовое соглашение, привязанное к объекту; один объект может иметь множество договоров.

**Поля:**
- `id` — уникальный идентификатор
- `object` — связь с объектом (ForeignKey)
- `number` — номер договора
- `name` — название / предмет договора
- `contract_date` — дата заключения
- `start_date` — дата начала работ (опционально)
- `end_date` — плановая дата завершения (опционально)
- `contractor` — контрагент
- `total_amount` — сумма договора
- `currency` — валюта (RUB/USD/EUR)
- `vat_rate` — ставка НДС, %
- `vat_included` — сумма включает НДС
- `status` — статус (planned/active/completed/suspended/terminated)
- `document_link` — ссылка на договор (опционально)
- `notes` — примечания (опционально)
- `created_at` — дата создания
- `updated_at` — дата обновления

**Ограничения:**
- Уникальность номера договора в пределах объекта

**Связи:**
- Принадлежит объекту (`object`)
- Имеет платежи (`payments`)
- Имеет плановые платежи (`planned_payments`)

**Методы:**
- `get_cash_flow(start_date=None, end_date=None)` — расчёт cash-flow для договора
- `get_cash_flow_by_periods(period_type='month', start_date=None, end_date=None)` — расчёт по периодам

### Payment (Платёж)
Фактический расход или поступление средств. Имеет источник (счёт компании), дату, сумму, ссылку на первичный документ в хранилище.

**Поля:**
- `id` — уникальный идентификатор
- `contract` — связь с договором (ForeignKey)
- `payment_type` — тип платежа (expense/income)
- `payment_date` — дата платежа
- `amount` — сумма платежа
- `company_account` — счёт компании (опционально)
- `description` — назначение платежа (опционально)
- `document_link` — ссылка на документ (опционально)
- `import_batch_id` — идентификатор импорта (опционально, с индексом)
- `created_at` — дата создания
- `updated_at` — дата обновления

**Индексы:**
- По дате платежа
- По типу и дате
- По договору и дате

**Связи:**
- Относится к договору (`contract`)
- Влияет на cash-flow

### PaymentRegistry (Реестр платежей)
Планируемые к исполнению платежи с указанием договоров и статуса.

**Поля:**
- `id` — уникальный идентификатор
- `contract` — связь с договором (ForeignKey)
- `planned_date` — плановая дата
- `amount` — сумма
- `status` — статус (planned/approved/cancelled)
- `initiator` — инициатор платежа (опционально)
- `comment` — комментарий (опционально)
- `created_at` — дата создания
- `updated_at` — дата обновления

**Индексы:**
- По плановой дате
- По статусу и дате
- По договору и дате

**Связи:**
- Привязка к договору (`contract`)
- Привязка к объекту через договор

### ImportLog (Журнал импортов)
Журнал импорта данных из файлов для учёта и аудита.

**Поля:**
- `id` — уникальный идентификатор
- `import_batch_id` — уникальный идентификатор импорта
- `user` — пользователь, выполнивший импорт (ForeignKey, nullable)
- `file_name` — имя файла
- `file_type` — тип файла (payments_actual/payments_plan/incomes/balance)
- `file_size` — размер файла в байтах
- `file_path` — путь к файлу в хранилище (опционально)
- `status` — статус обработки (pending/success/failed/partial)
- `records_count` — общее количество записей
- `success_count` — успешно обработано
- `error_count` — количество ошибок
- `errors` — описание ошибок (опционально)
- `import_date` — дата импорта
- `created_at` — дата создания
- `updated_at` — дата обновления

**Свойства:**
- `success_rate` — процент успешно обработанных записей (read-only property)

**Индексы:**
- По идентификатору импорта
- По статусу и дате
- По типу файла и дате
- По пользователю и дате

### UserProfile (Профиль пользователя)
Дополнительная информация о пользователе, включая фотографию.

**Поля:**
- `id` — уникальный идентификатор
- `user` — связь с пользователем (OneToOne)
- `photo` — фотография пользователя (ImageField, опционально)

**Связи:**
- Один к одному с User

---

## 3. Источники данных и форматы

### Табличные файлы (Excel/CSV)

#### Файл «Фактические платежи» (payments_actual.xlsx)
**Лист `payments`:**
- `object_code` — код объекта (строка, *обязательно*)
- `object_name` — название объекта (строка, *обязательно*)
- `contract_number` — номер договора (строка, *обязательно*)
- `contract_party` — контрагент (строка)
- `payment_type` — расход / поступление (строка, *обязательно*)
- `payment_date` — дата платежа (дата, *обязательно*)
- `amount` — сумма (число, *обязательно*)
- `company_account` — счёт компании (строка)
- `description` — назначение платежа (строка)
- `document_link` — путь/ссылка на первичный документ (строка)
- `import_batch_id` — идентификатор импорта (строка, заполняется системой)

#### Файл «Плановые платежи» (payments_plan.xlsx)
**Лист `planned_payments`:**
- `object_code`
- `contract_number`
- `planned_date`
- `amount`
- `status` — планируется / утверждено / отменено
- `initiator` — инициатор платежа
- `comment`

#### Файл «Поступления» (incomes.xlsx)
**Лист `incomes`:**
- `object_code`
- `contract_number`
- `income_date`
- `amount`
- `payer`
- `description`

#### Файл «Задолженность» (balance.xlsx)
**Лист `debts`:**
- `object_code`
- `contract_number`
- `debt_type` — дебиторская / кредиторская
- `amount`
- `as_of_date`

### Общие требования к файлам
- Формат: Excel (.xlsx) или CSV в UTF-8
- Названия листов фиксированы
- Первая строка — заголовки колонок
- Даты — `YYYY-MM-DD`
- Суммы — десятичные значения с точкой

### Каталог документов
- Структурирован по объектам и договорам
- Содержит первичные документы: счета, акты, договоры
- Ответственный за поддержание структуры: Проектный менеджер объекта

### Регламент обновления
1. **Ответственные**
   - Подготовка и загрузка файлов — Финансовый аналитик
   - Проверка корректности и утверждение — Финансовый директор

2. **Частота обновления**
   - Фактические платежи и поступления — ежедневно при наличии операций
   - Плановые платежи и задолженность — минимум раз в неделю

3. **Версионирование**
   - Каждая загрузка получает уникальный `import_batch_id`
   - Исходные файлы архивируются с меткой времени `YYYYMMDD_HHMM`

---

## 4. Архитектура системы

### Backend (Django REST)

**Слои:**
- `objects`, `contracts`, `payments`, `imports` — доменные приложения
- `core` — общие утилиты, настройки логирования, базовые модели

**База данных:**
- PostgreSQL с расширениями `pg_trgm` (поиск по названиям объектов) и `uuid-ossp` для идентификаторов импортов

**Интеграция с файловым хранилищем:**
- Локальный каталог/облачный бакет (путь хранится в платежах и импорт-логах)

**Расширяемость:**
- Возможность добавить модуль планирования ресурсов или аналитики без изменения ядра

### Frontend
- **Стек**: Next.js + TypeScript, UI-библиотека — Shadcn UI + Radix
- **Слои интерфейса**:
  - Панель объектов (список, фильтрация, статус)
  - Договоры и платежи (гриды, формы, ссылки на документы)
  - Отчёты и дашборды (cash-flow, задолженность)
- **Состояние**: React Query для работы с API, Zustand для локального стейта
- **Graph/Charts**: Recharts или Victory для визуализации cash-flow

### Межслойное взаимодействие
- REST API (JSON), авторизация через JWT (Simple JWT на backend)
- Версионирование API: `/api/v1/...` с возможностью добавлять v2 при изменениях
- Ограничение доступа: роли пользователей управляются на backend

### Структура проекта

```
finans_assistant/
├── backend/              # Django REST API
│   ├── contracts/        # Приложение договоров
│   ├── core/             # Общие компоненты
│   ├── imports/          # Импорт данных
│   ├── objects/          # Приложение объектов
│   ├── payments/         # Приложение платежей
│   └── finans_assistant/ # Настройки Django проекта
├── frontend/             # Next.js приложение
└── docs/                 # Документация проекта
```

---

## 5. API и сериализаторы

### Сериализаторы DRF

Все модели имеют два типа сериализаторов:
- **Полный сериализатор** — для детального просмотра (все поля)
- **List сериализатор** — для списков (упрощённые данные)

**Особенности:**
- Read-only поля: `id`, `created_at`, `updated_at`
- Автоматическое включение информации о связанных объектах
- Display поля для choice полей (например, `payment_type_display`, `status_display`)

### REST API Endpoints

#### Объекты
- `GET /api/v1/objects/` — список объектов
- `GET /api/v1/objects/{id}/` — детали объекта
- `POST /api/v1/objects/` — создать объект
- `PUT/PATCH /api/v1/objects/{id}/` — обновить объект
- `DELETE /api/v1/objects/{id}/` — удалить объект
- `GET /api/v1/objects/{id}/cash_flow/` — расчёт cash-flow
- `GET /api/v1/objects/{id}/cash_flow_periods/` — cash-flow по периодам

#### Договоры
- `GET /api/v1/contracts/` — список договоров
- `GET /api/v1/contracts/{id}/` — детали договора
- `POST /api/v1/contracts/` — создать договор
- `PUT/PATCH /api/v1/contracts/{id}/` — обновить договор
- `DELETE /api/v1/contracts/{id}/` — удалить договор
- `GET /api/v1/contracts/{id}/cash_flow/` — расчёт cash-flow
- `GET /api/v1/contracts/{id}/cash_flow_periods/` — cash-flow по периодам

#### Платежи
- `GET /api/v1/payments/` — список платежей
- `GET /api/v1/payments/{id}/` — детали платежа
- `POST /api/v1/payments/` — создать платёж
- `PUT/PATCH /api/v1/payments/{id}/` — обновить платёж
- `DELETE /api/v1/payments/{id}/` — удалить платёж

#### Плановые платежи
- `GET /api/v1/payment-registry/` — список плановых платежей
- `GET /api/v1/payment-registry/{id}/` — детали планового платежа
- `POST /api/v1/payment-registry/` — создать плановый платёж
- `PUT/PATCH /api/v1/payment-registry/{id}/` — обновить плановый платёж
- `DELETE /api/v1/payment-registry/{id}/` — удалить плановый платёж

#### Импорты
- `GET /api/v1/imports/` — список импортов (только чтение)
- `GET /api/v1/imports/{id}/` — детали импорта

#### Пользователи
- `GET /api/v1/users/me/` — информация о текущем пользователе
- `PUT/PATCH /api/v1/users/update_profile/` — обновить профиль (включая фото)
- `POST /api/v1/users/change_password/` — смена пароля

### Фильтрация и поиск

Все ViewSets поддерживают:
- **Фильтрацию** через query параметры (например: `?status=active&currency=RUB`)
- **Поиск** через параметр `search` (например: `?search=москва`)
- **Сортировку** через параметр `ordering` (например: `?ordering=-created_at`)
- **Пагинацию** (по 20 записей на страницу)

### Документация API

- **Swagger UI**: `/api/docs/` — интерактивная документация
- **ReDoc**: `/api/redoc/` — альтернативный интерфейс
- **OpenAPI Schema**: `/api/schema/` — JSON схема

---

## 6. Бизнес-логика

### Расчёты cash-flow

Реализован модуль `core/cashflow.py` с классом `CashFlowCalculator`.

**Основные методы:**

#### `calculate(object_id=None, contract_id=None, start_date=None, end_date=None)`
Универсальный метод для расчёта cash-flow:
- Для объекта: суммирует все договоры объекта
- Для договора: рассчитывает по платежам договора
- Для всех объектов: рассчитывает по всей компании

Возвращает: `{'income': Decimal, 'expense': Decimal, 'cash_flow': Decimal}`

#### `calculate_by_periods(object_id=None, contract_id=None, period_type='month', start_date=None, end_date=None)`
Расчёт cash-flow с разбивкой по периодам:
- `period_type`: 'month', 'week' или 'day'
- Возвращает: `List[Dict]` с данными по каждому периоду

**Особенности реализации:**
- Использование `Decimal` для точности финансовых вычислений
- Оптимизация запросов через агрегацию на уровне БД
- Группировка по периодам через Django ORM функции (`TruncMonth`, `TruncWeek`, `TruncDay`)

---

## 7. Аутентификация и безопасность

### JWT аутентификация

**Настройки:**
- `ACCESS_TOKEN_LIFETIME`: 1 час
- `REFRESH_TOKEN_LIFETIME`: 7 дней
- `ROTATE_REFRESH_TOKENS`: True
- `BLACKLIST_AFTER_ROTATION`: True

### Endpoints аутентификации

- `POST /api/v1/auth/login/` — получение JWT токенов
- `POST /api/v1/auth/refresh/` — обновление access токена
- `POST /api/v1/auth/verify/` — проверка токена
- `POST /api/v1/users/register/` — регистрация нового пользователя

### Защита endpoints

Все ViewSets требуют авторизации (`IsAuthenticated`), кроме:
- Регистрации (`/api/v1/users/register/`)

**Использование токена:**
```
Authorization: Bearer {access_token}
```

---

## 8. База данных

### PostgreSQL

**Настройки:**
- Драйвер: `psycopg2-binary`
- Расширения: `pg_trgm` (поиск), `uuid-ossp` (идентификаторы)

**Преимущества:**
- Производительность для production окружения
- Масштабируемость для больших объёмов данных
- Расширенные типы индексов
- Улучшенная поддержка транзакций

**Для production:**
- Использовать переменные окружения для паролей
- Настроить connection pooling
- Включить логирование запросов
- Настроить резервное копирование

---

## 9. Ключевые метрики и отчёты

- Cash-flow по объектам и по всей компании за произвольные периоды
- Сводка расходов и доходов по договорам
- Актуальный реестр планируемых платежей
- Статус дебиторской и кредиторской задолженности

---

## 10. Ограничения и риски

- Точность данных зависит от своевременного обновления файлов и корректности импорта
- Требуется выстроенный регламент хранения и структурирования документов
- Необходимо обеспечить разграничение доступа и аудит операций импорта

