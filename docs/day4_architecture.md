# День 4. Архитектура и окружение

## 1. Архитектура системы

### 1.1. Backend (Django REST)
- **Слои**:
  - `objects`, `contracts`, `payments`, `registry`, `imports` — доменные приложения.
  - `api` — набор DRF viewsets/serializers (общий модуль для REST-интерфейса).
  - `core` — общие утилиты, настройки логирования, базовые модели.
- **База данных**: PostgreSQL с расширениями `pg_trgm` (поиск по названиям объектов) и `uuid-ossp` для идентификаторов импортов.
- **Интеграция с файловым хранилищем**: локальный каталог/облачный бакет (путь хранится в платежах и импорт-логах).
- **Расширяемость**: возможность добавить модуль планирования ресурсов или аналитики без изменения ядра.

### 1.2. Frontend
- **Стек**: Next.js + TypeScript, UI-библиотека — Shadcn UI + Radix.
- **Слои интерфейса**:
  - Панель объектов (список, фильтрация, статус).
  - Договоры и платежи (гриды, формы, ссылки на документы).
  - Отчёты и дашборды (cash-flow, задолженность).
- **Состояние**: React Query для работы с API, Zustand для локального стейта.
- **Graph/Charts**: Recharts или Victory для визуализации cash-flow.

### 1.3. Межслойное взаимодействие
- REST API (JSON), авторизация через JWT (Simple JWT на backend, secure cookies на frontend).
- Версионирование API: `/api/v1/...` с возможностью добавлять v2 при изменениях.
- Ограничение доступа: роли пользователей управляются на backend, фронтенд получает claims.

## 2. Окружение и CI/CD

### 2.1. Окружения
- `dev` — локальная разработка (Docker Compose: Django + PostgreSQL + MinIO/локальное хранилище файлов).
- `staging` — для тестирования, содержит копию структуры БД и песочницу файлов.
- `prod` — production, управляемые секреты и резервное копирование.

### 2.2. CI/CD пайплайн
- **CI** (GitHub Actions):
  1. Линтеры (flake8, black, isort) и mypy для backend.
  2. Jest + ESLint для фронтенда.
  3. Unit-тесты Django, генерация отчёта покрытия.
  4. Сборка Docker-образов backend/frontend.
- **CD**:
  - Staging: автодеплой по merge в `develop`.
  - Production: ручной запуск workflow с проверкой чек-листа.
  - Миграции БД выполняются автоматически с откатом при ошибке.

### 2.3. Мониторинг и логирование
- Sentry (backend/frontend) для ошибок.
- Prometheus + Grafana для метрик (нагрузка, время отклика).
- Логи импортов и платежей пишутся в отдельную таблицу `audit_log`.

## 3. Формат обмена данными и хранение исходников
- Исходные файлы хранятся в `storage/raw/<year>/<object_code>/...` с правами на чтение только у аналитиков.
- После успешного импорта данные сохраняются в `storage/processed/<import_batch_id>/`.
- Обмен между командами осуществляется через общий S3-бакет/сетевой ресурс с версионированием.
- Для импорта используется REST endpoint `/api/v1/imports/upload/`, который принимает файл и метаданные.
- Журнал `ImportLog` фиксирует имя файла, размер, тип, идентификатор импорта и статус обработки.
