# –û—Ç—á—ë—Ç –ø–æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥—É –ø—Ä–æ–µ–∫—Ç–∞ Finans Assistant ‚Äî –í–µ—Ä—Å–∏—è 3

**–°—Ç–∞—Ç—É—Å: ‚úÖ –ó–ê–í–ï–†–®–Å–ù**  
**–î–∞—Ç–∞: 04.01.2026**  
**–û–±–Ω–æ–≤–ª–µ–Ω–æ: 04.01.2026**

## –°–≤–æ–¥–∫–∞

–ü—Ä–æ–≤–µ–¥—ë–Ω —Ç—Ä–µ—Ç–∏–π –∞–Ω–∞–ª–∏–∑ –∫–æ–¥–æ–≤–æ–π –±–∞–∑—ã –ø–æ—Å–ª–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å—á–µ—Ç–æ–≤ —á–µ—Ä–µ–∑ LLM.  
–í—ã—è–≤–ª–µ–Ω–æ **20 –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º** —Ä–∞–∑–Ω–æ–π —Å—Ç–µ–ø–µ–Ω–∏ –∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç–∏ –∏ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ—Å—Ç–∏.

| –ö–∞—Ç–µ–≥–æ—Ä–∏—è | –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö | –°—Ä–µ–¥–Ω–∏—Ö | –ù–∏–∑–∫–∏—Ö | –û—Ç–ª–æ–∂–µ–Ω–Ω—ã—Ö |
|-----------|-------------|---------|--------|------------|
| –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ—Å—Ç—å/–ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å | 2 | 1 | - | - |
| –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å | 1 | 2 | 2 | - |
| –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å | 1 | 3 | 1 | - |
| –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞/DevOps | 1 | 1 | - | 1 |
| –ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞ | - | 2 | 2 | - |

---

## üìä –ê–ù–ê–õ–ò–ó –ö–ê–ñ–î–û–ô –ü–†–û–ë–õ–ï–ú–´

---

### üî¥ –ü—Ä–æ–±–ª–µ–º–∞ 1: –ù–µ–ø—Ä–∏–º–µ–Ω—ë–Ω–Ω—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏ (contracts, objects)

**–û–ø–∏—Å–∞–Ω–∏–µ:**  
–í –ª–æ–≥–∞—Ö dev-—Å–µ—Ä–≤–µ—Ä–∞: `You have 2 unapplied migration(s) ‚Ä¶ contracts, objects`.

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑:**  
- ‚ùì **–ù–∞—Å–∫–æ–ª—å–∫–æ —ç—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ?** –°—Ä–µ–¥–Ω–µ-–≤—ã—Å–æ–∫–æ. –ù–µ–ø—Ä–∏–º–µ–Ω—ë–Ω–Ω—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –º–æ–≥—É—Ç –≤—ã–∑–≤–∞—Ç—å –æ—à–∏–±–∫–∏ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ –Ω–æ–≤—ã–º –ø–æ–ª—è–º/—Ç–∞–±–ª–∏—Ü–∞–º.
- ‚ùì **–ü–æ—á–µ–º—É —ç—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ?** –°–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ, –º–∏–≥—Ä–∞—Ü–∏–∏ –±—ã–ª–∏ —Å–æ–∑–¥–∞–Ω—ã, –Ω–æ –Ω–µ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –Ω–∞ dev-—Å–µ—Ä–≤–µ—Ä–µ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞.
- ‚ùì **–≠—Ç–æ —Å–∏—Å—Ç–µ–º–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞?** –ù–µ—Ç, —ç—Ç–æ –ª–æ–∫–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è.

**–†–µ—à–µ–Ω–∏–µ:**
```bash
python manage.py migrate contracts
python manage.py migrate objects
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –Ω–∞ –±—É–¥—É—â–µ–µ:**
- –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –º–∏–≥—Ä–∞—Ü–∏–π –≤ CI/CD pipeline
- –î–æ–±–∞–≤–∏—Ç—å pre-commit hook –∏–ª–∏ startup check

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π (–Ω–æ —Ä–µ—à–∞–µ—Ç—Å—è –∑–∞ 1 –º–∏–Ω—É—Ç—É)  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –¢—Ä–∏–≤–∏–∞–ª—å–Ω–∞—è  
**–°—Ç–∞—Ç—É—Å:** ‚è≥ –¢—Ä–µ–±—É–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

---

### üî¥ –ü—Ä–æ–±–ª–µ–º–∞ 2: –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥ LLM –ø–æ –æ–¥–Ω–æ–º—É —Ñ–∞–π–ª—É (Race Condition)

**–û–ø–∏—Å–∞–Ω–∏–µ:**  
–ü—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ `ParsedDocument` —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º –Ω–µ SUCCESS –∑–∞–ø–∏—Å—å —É–¥–∞–ª—è–µ—Ç—Å—è –∏ —Å–æ–∑–¥–∞—ë—Ç—Å—è –Ω–æ–≤–∞—è. –ü—Ä–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö –≤–æ–∑–º–æ–∂–Ω–∞ –≥–æ–Ω–∫–∞.

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑:**  
- ‚ùì **–ù–∞—Å–∫–æ–ª—å–∫–æ —ç—Ç–æ —Ä–µ–∞–ª—å–Ω–æ?** –ü—Ä–∏ 4-6 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö ‚Äî –º–∞–ª–æ–≤–µ—Ä–æ—è—Ç–Ω–æ. –î–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ–ª–∂–Ω—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å –û–î–ò–ù –ò –¢–û–¢ –ñ–ï —Ñ–∞–π–ª –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ.
- ‚ùì **–ö–∞–∫–æ–≤ —É—â–µ—Ä–±?** –ü–æ—Ç–µ—Ä—è –æ–¥–Ω–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞, –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—ã–∑–æ–≤ LLM (–ª–∏—à–Ω–∏–µ —Ç–æ–∫–µ–Ω—ã).
- ‚ùì **–°—Ç–æ–∏—Ç –ª–∏ —É—Å–ª–æ–∂–Ω—è—Ç—å –∫–æ–¥?** –î–ª—è —Ç–µ–∫—É—â–µ–π –Ω–∞–≥—Ä—É–∑–∫–∏ ‚Äî —Å–ø–æ—Ä–Ω–æ.

**–í–∞—Ä–∏–∞–Ω—Ç—ã —Ä–µ—à–µ–Ω–∏—è:**

**–í–∞—Ä–∏–∞–Ω—Ç A: SELECT ... FOR UPDATE (–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å—Ç—Ä–æ–∫–∏)**
```python
from django.db import transaction

def parse_invoice(self, pdf_content, filename, payment=None):
    file_hash = BaseLLMProvider.calculate_file_hash(pdf_content)
    
    with transaction.atomic():
        existing = ParsedDocument.objects.select_for_update().filter(
            file_hash=file_hash
        ).first()
        
        if existing:
            if existing.status == ParsedDocument.Status.SUCCESS:
                return self._build_response(existing, from_cache=True)
            elif existing.status == ParsedDocument.Status.PENDING:
                # –ö—Ç–æ-—Ç–æ —É–∂–µ –ø–∞—Ä—Å–∏—Ç ‚Äî –∂–¥—ë–º –∏–ª–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º "–≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ"
                return {'success': False, 'error': '–î–æ–∫—É–º–µ–Ω—Ç —É–∂–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è', ...}
            else:
                existing.delete()
        
        parsed_doc = ParsedDocument.objects.create(...)
    
    # –ü–∞—Ä—Å–∏–Ω–≥ –≤–Ω–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
    ...
```

**–í–∞—Ä–∏–∞–Ω—Ç B: –°—Ç–∞—Ç—É—Å PENDING + retry –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ**
```python
if existing and existing.status == ParsedDocument.Status.PENDING:
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ "–∑–∞–≤–∏—Å" –ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç (> 5 –º–∏–Ω—É—Ç)
    if existing.created_at < timezone.now() - timedelta(minutes=5):
        existing.delete()
    else:
        return Response({'status': 'processing', 'retry_after': 10}, status=202)
```

**–í–∞—Ä–∏–∞–Ω—Ç C: get_or_create —Å update_or_create**
```python
parsed_doc, created = ParsedDocument.objects.get_or_create(
    file_hash=file_hash,
    defaults={
        'original_filename': filename,
        'provider': self.provider_model,
        'status': ParsedDocument.Status.PENDING
    }
)
if not created and parsed_doc.status == ParsedDocument.Status.SUCCESS:
    return self._build_response(parsed_doc, from_cache=True)
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –í–∞—Ä–∏–∞–Ω—Ç B ‚Äî –ø—Ä–æ—Å—Ç–æ–π, –ø–æ–Ω—è—Ç–Ω—ã–π, –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –ë–î.

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° –°—Ä–µ–¥–Ω–∏–π (–¥–ª—è —Ç–µ–∫—É—â–µ–π –Ω–∞–≥—Ä—É–∑–∫–∏)  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –°—Ä–µ–¥–Ω—è—è  
**–°—Ç–∞—Ç—É—Å:** üìã –ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è

---

### üü° –ü—Ä–æ–±–ª–µ–º–∞ 3: –£–Ω–∏–∫–∞–ª—å–Ω—ã–π file_hash –±–µ–∑ grace-–ø–æ–≤–µ–¥–µ–Ω–∏—è

**–û–ø–∏—Å–∞–Ω–∏–µ:**  
–û—à–∏–±–∫–∞ IntegrityError —Ä–µ—à–µ–Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ–º –Ω–µ—É—Å–ø–µ—à–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π, –Ω–æ –Ω–µ—Ç backoff/–ª–∏–º–∏—Ç–∞ —Ä–µ—Ç—Ä–∞–µ–≤.

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑:**  
- ‚ùì **–≠—Ç–æ —Ä–µ–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞?** –ß–∞—Å—Ç–∏—á–Ω–æ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ü—Ä–æ–±–ª–µ–º–æ–π 2.
- ‚ùì **–ù—É–∂–µ–Ω –ª–∏ —Å—á—ë—Ç—á–∏–∫ –ø–æ–ø—ã—Ç–æ–∫?** –î–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –∑–∞—Ü–∏–∫–ª–∏–≤–∞–Ω–∏—è ‚Äî –¥–∞.
- ‚ùì **–ö–∞–∫ —á–∞—Å—Ç–æ —Ñ–∞–π–ª –Ω–µ –ø–∞—Ä—Å–∏—Ç—Å—è?** –†–µ–¥–∫–æ, –µ—Å–ª–∏ LLM —Ä–∞–±–æ—Ç–∞–µ—Ç.

**–†–µ—à–µ–Ω–∏–µ:**  
–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ `retry_count` –≤ `ParsedDocument`:

```python
class ParsedDocument(TimestampedModel):
    # ...
    retry_count = models.PositiveSmallIntegerField(default=0)
    
# –í DocumentParser:
MAX_PARSE_RETRIES = 3

if existing and existing.status == ParsedDocument.Status.FAILED:
    if existing.retry_count >= MAX_PARSE_RETRIES:
        return {'success': False, 'error': '–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –ø–æ–ø—ã—Ç–æ–∫ –ø–∞—Ä—Å–∏–Ω–≥–∞'}
    existing.retry_count += 1
    existing.status = ParsedDocument.Status.PENDING
    existing.save()
    parsed_doc = existing
else:
    parsed_doc = ParsedDocument.objects.create(...)
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü¢ –ù–∏–∑–∫–∏–π  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –ù–∏–∑–∫–∞—è  
**–°—Ç–∞—Ç—É—Å:** üìã –ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è

---

### üî¥ –ü—Ä–æ–±–ª–µ–º–∞ 4: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–æ–≤

**–û–ø–∏—Å–∞–Ω–∏–µ:**  
–ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–∑–º–µ—Ä–∞/—Å—Ç—Ä–∞–Ω–∏—Ü PDF ‚Üí —Ä–∏—Å–∫ OOM –∏ –¥–æ–ª–≥–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤.

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑:**  
- ‚ùì **–†–µ–∞–ª—å–Ω–æ –ª–∏ —ç—Ç–æ?** –î–∞! –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –∑–∞–≥—Ä—É–∑–∏—Ç—å 100MB PDF —Å 500 —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º–∏.
- ‚ùì **–ö–∞–∫–æ–≤—ã –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è?** –ó–∞–≤–∏—Å–∞–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞, –∏—Å—á–µ—Ä–ø–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ LLM ($$$), timeout.
- ‚ùì **–°–ª–æ–∂–Ω–æ –ª–∏ –∏—Å–ø—Ä–∞–≤–∏—Ç—å?** –ù–µ—Ç.

**–†–µ—à–µ–Ω–∏–µ:**

```python
# llm_services/views.py

MAX_FILE_SIZE_MB = 10
MAX_PDF_PAGES = 20

@api_view(['POST', 'OPTIONS'])
def parse_invoice(request):
    file = request.FILES['file']
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞
    if file.size > MAX_FILE_SIZE_MB * 1024 * 1024:
        return Response(
            {'error': f'–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º—É–º: {MAX_FILE_SIZE_MB} MB'},
            status=status.HTTP_413_REQUEST_ENTITY_TOO_LARGE
        )
    
    file_content = file.read()
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å—Ç—Ä–∞–Ω–∏—Ü –¥–ª—è PDF
    if file.name.lower().endswith('.pdf'):
        import fitz
        try:
            doc = fitz.open(stream=file_content, filetype='pdf')
            if len(doc) > MAX_PDF_PAGES:
                doc.close()
                return Response(
                    {'error': f'PDF —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ —Å—Ç—Ä–∞–Ω–∏—Ü. –ú–∞–∫—Å–∏–º—É–º: {MAX_PDF_PAGES}'},
                    status=status.HTTP_400_BAD_REQUEST
                )
            doc.close()
        except Exception:
            pass  # –ù–µ PDF –∏–ª–∏ –ø–æ–≤—Ä–µ–∂–¥—ë–Ω ‚Äî –¥–∞–ª—å—à–µ –æ–±—Ä–∞–±–æ—Ç–∞–µ–º
    
    # ... –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ
```

**–í—ã–Ω–µ—Å—Ç–∏ –≤ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã:**
```python
# core/constants.py
LLM_MAX_FILE_SIZE_MB = 10
LLM_MAX_PDF_PAGES = 20
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –ù–∏–∑–∫–∞—è  
**–°—Ç–∞—Ç—É—Å:** üìã –ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è

---

### üü° –ü—Ä–æ–±–ª–µ–º–∞ 5: –ù–µ—Ç –∫–æ–Ω—Ç—Ä–æ–ª—è —Ç–∞–π–º–∞—É—Ç–æ–≤ –¥–ª—è LLM-–ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤

**–û–ø–∏—Å–∞–Ω–∏–µ:**  
`_parse_with_retries` –ª–æ–≤–∏—Ç Exception, –Ω–æ –Ω–µ—Ç per-provider —Ç–∞–π–º–∞—É—Ç–æ–≤.

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑:**  
- ‚ùì **–†–µ–∞–ª—å–Ω–æ –ª–∏ –∑–∞–≤–∏—Å–∞–Ω–∏–µ?** –î–∞, –æ—Å–æ–±–µ–Ω–Ω–æ –¥–ª—è Grok (—É–∂–µ –≤–∏–¥–µ–ª–∏ ReadTimeout).
- ‚ùì **–ï—Å—Ç—å –ª–∏ —Ç–∞–π–º–∞—É—Ç—ã –≤ SDK?** OpenAI ‚Äî –¥–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ~10 –º–∏–Ω), Gemini ‚Äî –¥–∞, Grok (httpx) ‚Äî –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è.
- ‚ùì **–ù—É–∂–Ω–æ –ª–∏ —è–≤–Ω–æ –∑–∞–¥–∞–≤–∞—Ç—å?** –ñ–µ–ª–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ—Å—Ç–∏.

**–†–µ—à–µ–Ω–∏–µ:**

```python
# llm_services/providers/openai_provider.py
from openai import OpenAI

class OpenAIProvider(BaseLLMProvider):
    def __init__(self, model_name: str, api_key: str):
        self.client = OpenAI(
            api_key=api_key,
            timeout=60.0,  # 60 —Å–µ–∫—É–Ω–¥ –Ω–∞ –∑–∞–ø—Ä–æ—Å
            max_retries=2
        )

# llm_services/providers/grok_provider.py
import httpx

class GrokProvider(BaseLLMProvider):
    def __init__(self, ...):
        self.client = httpx.Client(timeout=httpx.Timeout(60.0))
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° –°—Ä–µ–¥–Ω–∏–π  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –ù–∏–∑–∫–∞—è  
**–°—Ç–∞—Ç—É—Å:** üìã –ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è

---

### üü¢ –ü—Ä–æ–±–ª–µ–º–∞ 6: –ù–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ—Å—Ç—å –≤—ã–±–æ—Ä–∞ default LLM-–ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞

**–û–ø–∏—Å–∞–Ω–∏–µ:**  
`LLMProvider.get_default()` –±–µ—Ä—ë—Ç "–ø–µ—Ä–≤—ã–π –∞–∫—Ç–∏–≤–Ω—ã–π" –±–µ–∑ –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ—Ä—è–¥–∫–∞.

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑:**  
- ‚ùì **–≠—Ç–æ –ø—Ä–æ–±–ª–µ–º–∞?** –î–∞, –Ω–æ –º–∏–Ω–æ—Ä–Ω–∞—è. –ü–æ—Ä—è–¥–æ–∫ –±—É–¥–µ—Ç –ø–æ `pk` (–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π).
- ‚ùì **–ú–æ–∂–µ—Ç –ª–∏ —Å–ª–æ–º–∞—Ç—å—Å—è?** –¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏, –µ—Å–ª–∏ –≤—Å–µ `is_default=False`, –≤—ã–±–µ—Ä–µ—Ç—Å—è —Å–ª—É—á–∞–π–Ω—ã–π.
- ‚ùì **–°—Ç–æ–∏—Ç –ª–∏ –∏—Å–ø—Ä–∞–≤–ª—è—Ç—å?** –î–∞, –¥–ª—è –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏.

**–†–µ—à–µ–Ω–∏–µ:**

```python
# llm_services/models.py
@classmethod
def get_default(cls) -> 'LLMProvider':
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–æ–≤–∞–π–¥–µ—Ä –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é"""
    # –°–Ω–∞—á–∞–ª–∞ –∏—â–µ–º —è–≤–Ω–æ –ø–æ–º–µ—á–µ–Ω–Ω—ã–π –∫–∞–∫ default
    provider = cls.objects.filter(is_default=True, is_active=True).first()
    if provider:
        return provider
    
    # –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –±–µ—Ä—ë–º –ø–µ—Ä–≤—ã–π –∞–∫—Ç–∏–≤–Ω—ã–π (–ø–æ pk –¥–ª—è –¥–µ—Ç–µ—Ä–º–∏–Ω–∏–∑–º–∞)
    provider = cls.objects.filter(is_active=True).order_by('pk').first()
    if not provider:
        raise cls.DoesNotExist("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö LLM-–ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤")
    
    return provider
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü¢ –ù–∏–∑–∫–∏–π  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –¢—Ä–∏–≤–∏–∞–ª—å–Ω–∞—è  
**–°—Ç–∞—Ç—É—Å:** üìã –ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è

---

### üü° –ü—Ä–æ–±–ª–µ–º–∞ 7: –•—Ä–∞–Ω–µ–Ω–∏–µ —Å—ã—Ä—ã—Ö LLM-–æ—Ç–≤–µ—Ç–æ–≤ –±–µ–∑ –æ—á–∏—Å—Ç–∫–∏ –∏ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è

**–û–ø–∏—Å–∞–Ω–∏–µ:**  
`ParsedDocument.raw_response` –∏ `parsed_data` —Ö—Ä–∞–Ω—è—Ç—Å—è –±–µ–∑ –º–∞—Å–∫–∏—Ä–æ–≤–∫–∏ –∏ —Å—Ä–æ–∫–∞ –∂–∏–∑–Ω–∏.

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑:**  
- ‚ùì **–ï—Å—Ç—å –ª–∏ —Ç–∞–º PII?** –°—á–µ—Ç–∞ —Å–æ–¥–µ—Ä–∂–∞—Ç: –Ω–∞–∑–≤–∞–Ω–∏—è –∫–æ–º–ø–∞–Ω–∏–π, –ò–ù–ù, –∞–¥—Ä–µ—Å–∞, —Å—É–º–º—ã ‚Äî —ç—Ç–æ –∫–æ–º–º–µ—Ä—á–µ—Å–∫–∞—è —Ç–∞–π–Ω–∞, –Ω–æ –Ω–µ PII –≤ —Å—Ç—Ä–æ–≥–æ–º —Å–º—ã—Å–ª–µ.
- ‚ùì **–ù—É–∂–Ω–æ –ª–∏ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ?** –î–ª—è prod ‚Äî –∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ. –î–ª—è dev ‚Äî –∏–∑–±—ã—Ç–æ—á–Ω–æ.
- ‚ùì **–ù—É–∂–Ω–∞ –ª–∏ —Ä–æ—Ç–∞—Ü–∏—è?** –î–∞, —Å—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏ —Å—Ç–æ–∏—Ç —É–¥–∞–ª—è—Ç—å.

**–†–µ—à–µ–Ω–∏–µ (–ø–æ—ç—Ç–∞–ø–Ω–æ–µ):**

**–≠—Ç–∞–ø 1: –î–æ–±–∞–≤–∏—Ç—å management command –¥–ª—è –æ—á–∏—Å—Ç–∫–∏:**
```python
# llm_services/management/commands/cleanup_parsed_docs.py
from django.core.management.base import BaseCommand
from django.utils import timezone
from datetime import timedelta
from llm_services.models import ParsedDocument

class Command(BaseCommand):
    help = '–£–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä—ã–µ ParsedDocument'
    
    def add_arguments(self, parser):
        parser.add_argument('--days', type=int, default=90)
    
    def handle(self, *args, **options):
        cutoff = timezone.now() - timedelta(days=options['days'])
        deleted, _ = ParsedDocument.objects.filter(
            created_at__lt=cutoff
        ).delete()
        self.stdout.write(f'–£–¥–∞–ª–µ–Ω–æ {deleted} –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤')
```

**–≠—Ç–∞–ø 2 (prod): –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ JSONField**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `django-encrypted-model-fields` –∏–ª–∏ –∫–∞—Å—Ç–æ–º–Ω–æ–µ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ
- –û—Ç–ª–æ–∂–∏—Ç—å –¥–æ production readiness

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° –°—Ä–µ–¥–Ω–∏–π (retention), üü¢ –ù–∏–∑–∫–∏–π (—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ)  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –ù–∏–∑–∫–∞—è (retention), –í—ã—Å–æ–∫–∞—è (—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ)  
**–°—Ç–∞—Ç—É—Å:** üìã Retention ‚Äî –ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è, –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ ‚Äî –æ—Ç–ª–æ–∂–µ–Ω–æ

---

### üü† –ü—Ä–æ–±–ª–µ–º–∞ 8: CORS_ALLOW_ALL_ORIGINS=True –±–µ–∑ –∑–∞—â–∏—Ç—ã –¥–ª—è prod

**–û–ø–∏—Å–∞–Ω–∏–µ:**  
–í settings –≤–∫–ª—é—á–µ–Ω–æ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏, –Ω–æ –Ω–µ—Ç guard –¥–ª—è prod.

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑:**  
- ‚ùì **–≠—Ç–æ –ø—Ä–æ–±–ª–µ–º–∞ —Å–µ–π—á–∞—Å?** –ù–µ—Ç, —ç—Ç–æ dev-–æ–∫—Ä—É–∂–µ–Ω–∏–µ.
- ‚ùì **–ó–∞–±—É–¥—É—Ç –ª–∏ –æ—Ç–∫–ª—é—á–∏—Ç—å?** –†–∏—Å–∫ –µ—Å—Ç—å.
- ‚ùì **–ö–∞–∫ –∑–∞—â–∏—Ç–∏—Ç—å—Å—è?** –ü—Ä–∏–≤—è–∑–∞—Ç—å –∫ DEBUG –∏–ª–∏ –æ—Ç–¥–µ–ª—å–Ω–æ–π ENV-–ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π.

**–†–µ—à–µ–Ω–∏–µ:**

```python
# settings.py
import os

DEBUG = os.environ.get('DEBUG', 'True').lower() == 'true'

# CORS
if DEBUG:
    CORS_ALLOW_ALL_ORIGINS = True
else:
    CORS_ALLOW_ALL_ORIGINS = False
    CORS_ALLOWED_ORIGINS = [
        "https://your-production-domain.com",
        # ...
    ]
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü¢ –ù–∏–∑–∫–∏–π (dev), üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π (prod)  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –¢—Ä–∏–≤–∏–∞–ª—å–Ω–∞—è  
**–°—Ç–∞—Ç—É—Å:** ‚è∏Ô∏è –û—Ç–ª–æ–∂–µ–Ω–æ –¥–æ pre-prod

---

### üü° –ü—Ä–æ–±–ª–µ–º–∞ 9: –ü–ª–∞—Ç–µ–∂–∏ ‚Äî —Ä–∞—Å—á—ë—Ç —Å—É–º–º –Ω–∞ –ª–µ—Ç—É, NULL –≤ —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å—è—Ö

**–û–ø–∏—Å–∞–Ω–∏–µ:**  
`PaymentViewSet.get_queryset` –∞–Ω–Ω–æ—Ç–∏—Ä—É–µ—Ç —Å—É–º–º—ã, –Ω–æ —Å—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏ –∏–º–µ—é—Ç NULL.

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑:**  
- ‚ùì **–≠—Ç–æ —Ä–µ–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞?** –î–∞, —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –ø–æ–ª—É—á–∞–µ—Ç `undefined`.
- ‚ùì **–ö–∞–∫ –∏—Å–ø—Ä–∞–≤–∏—Ç—å?** –î–≤–∞ –ø–æ–¥—Ö–æ–¥–∞: –º–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ fallback –≤ —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ç–æ—Ä–µ.
- ‚ùì **–ü–æ—á–µ–º—É —Å—É–º–º—ã NULL?** –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–µ–π –±–µ–∑ items —Å—É–º–º—ã –Ω–µ –∑–∞–ø–æ–ª–Ω—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.

**–†–µ—à–µ–Ω–∏–µ:**

**–í–∞—Ä–∏–∞–Ω—Ç A: –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö (one-time fix)**
```python
# payments/management/commands/fill_payment_amounts.py
from django.core.management.base import BaseCommand
from payments.models import Payment

class Command(BaseCommand):
    def handle(self, *args, **options):
        payments = Payment.objects.filter(amount_gross__isnull=True)
        for payment in payments:
            if payment.items.exists():
                payment.amount_gross = sum(item.amount for item in payment.items.all())
                # ... –≤—ã—á–∏—Å–ª—è–µ–º amount_net –∏ vat_amount
                payment.save()
            else:
                # –ï—Å–ª–∏ –Ω–µ—Ç items, –∏—Å–ø–æ–ª—å–∑—É–µ–º amount –∫–∞–∫ fallback
                payment.amount_gross = payment.amount
                payment.save()
```

**–í–∞—Ä–∏–∞–Ω—Ç B: Fallback –≤ —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ç–æ—Ä–µ (—É–∂–µ —á–∞—Å—Ç–∏—á–Ω–æ —Å–¥–µ–ª–∞–Ω–æ)**
```python
def get_amount_gross(self, obj):
    if obj.amount_gross:
        return str(obj.amount_gross)
    # Fallback –Ω–∞ amount –∏–ª–∏ —Å—É–º–º—É items
    if obj.items.exists():
        return str(sum(item.amount for item in obj.items.all()))
    return str(obj.amount) if obj.amount else '0.00'
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –í—ã–ø–æ–ª–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –¥–∞–Ω–Ω—ã—Ö + –æ—Å—Ç–∞–≤–∏—Ç—å fallback.

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° –°—Ä–µ–¥–Ω–∏–π  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –°—Ä–µ–¥–Ω—è—è  
**–°—Ç–∞—Ç—É—Å:** üìã –ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è

---

### üî¥ –ü—Ä–æ–±–ª–µ–º–∞ 10: –û–±—Ö–æ–¥ queryset —Å –º–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π –≤—Å–µ—Ö –æ–±—ä–µ–∫—Ç–æ–≤

**–û–ø–∏—Å–∞–Ω–∏–µ:**  
–í `PaymentViewSet.get_queryset` –ø–æ—Å–ª–µ –∞–Ω–Ω–æ—Ç–∞—Ü–∏–π –∏–¥—ë—Ç —Ü–∏–∫–ª `for payment in queryset:`.

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑:**  
- ‚ùì **–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–±–ª–µ–º–∞?** –î–ê! –≠—Ç–æ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –í–°–ï –ø–ª–∞—Ç–µ–∂–∏ –≤ –ø–∞–º—è—Ç—å –ø—Ä–∏ –ª—é–±–æ–º –∑–∞–ø—Ä–æ—Å–µ, –≤–∫–ª—é—á–∞—è list.
- ‚ùì **–ü–æ—á–µ–º—É —ç—Ç–æ —Å–¥–µ–ª–∞–Ω–æ?** –ü–æ–ø—ã—Ç–∫–∞ –ø—Ä–∏—Å–≤–æ–∏—Ç—å –∞–Ω–Ω–æ—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–∞–ø—Ä—è–º—É—é –æ–±—ä–µ–∫—Ç–∞–º.
- ‚ùì **–ö–∞–∫ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å?** –ê–Ω–Ω–æ—Ç–∞—Ü–∏–∏ –¥–æ–ª–∂–Ω—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –≤ —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ç–æ—Ä–µ —á–µ—Ä–µ–∑ `hasattr`.

**–ü—Ä–æ–≤–µ—Ä–∫–∞ (–Ω—É–∂–Ω–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∫–æ–¥):**

```python
# –ï—Å–ª–∏ –∫–æ–¥ –≤—ã–≥–ª—è–¥–∏—Ç —Ç–∞–∫ ‚Äî —ç—Ç–æ –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ø—Ä–æ–±–ª–µ–º–∞:
def get_queryset(self):
    queryset = super().get_queryset().annotate(...)
    for payment in queryset:  # ‚Üê –ü–õ–û–•–û! –ú–∞—Ç–µ—Ä–∏–∞–ª–∏–∑—É–µ—Ç –≤–µ—Å—å queryset
        payment.amount_gross = payment.annotated_amount_gross
    return queryset  # ‚Üê –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —É–∂–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫
```

**–†–µ—à–µ–Ω–∏–µ:**  
–£–¥–∞–ª–∏—Ç—å —Ü–∏–∫–ª, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏ –Ω–∞–ø—Ä—è–º—É—é –≤ —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ç–æ—Ä–µ:

```python
# payments/views.py
def get_queryset(self):
    queryset = super().get_queryset().annotate(
        annotated_items_count=Count('items'),
        # ...
    )
    return queryset  # –ë–ï–ó —Ü–∏–∫–ª–∞!

# payments/serializers.py
def get_amount_gross(self, obj):
    if hasattr(obj, 'annotated_amount_gross') and obj.annotated_amount_gross:
        return str(obj.annotated_amount_gross)
    return str(obj.amount_gross) if obj.amount_gross else None
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –°—Ä–µ–¥–Ω—è—è  
**–°—Ç–∞—Ç—É—Å:** üìã –ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è

---

### üü° –ü—Ä–æ–±–ª–µ–º–∞ 11: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ª–∏–º–∏—Ç–æ–≤ –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–∑–∏—Ü–∏–π (items)

**–û–ø–∏—Å–∞–Ω–∏–µ:**  
–ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —á–∏—Å–ª–∞ line items –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ/—Å–æ–∑–¥–∞–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞.

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑:**  
- ‚ùì **–†–µ–∞–ª—å–Ω–æ –ª–∏ —ç—Ç–æ?** –ë–æ–ª—å—à–∏–µ –Ω–∞–∫–ª–∞–¥–Ω—ã–µ –º–æ–≥—É—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Å–æ—Ç–Ω–∏ –ø–æ–∑–∏—Ü–∏–π.
- ‚ùì **–ö–∞–∫–æ–≤ —É—â–µ—Ä–±?** –î–æ–ª–≥–∏–π –ø–∞—Ä—Å–∏–Ω–≥, –±–æ–ª—å—à–∏–µ —Ç–æ–∫–µ–Ω—ã LLM, —Ä–∞–∑–¥—É–≤–∞–Ω–∏–µ –ë–î.
- ‚ùì **–ö–∞–∫–æ–π —Ä–∞–∑—É–º–Ω—ã–π –ª–∏–º–∏—Ç?** 100-200 –ø–æ–∑–∏—Ü–∏–π –Ω–∞ –æ–¥–∏–Ω –ø–ª–∞—Ç—ë–∂.

**–†–µ—à–µ–Ω–∏–µ:**

```python
# payments/serializers.py
MAX_PAYMENT_ITEMS = 200

class PaymentSerializer(serializers.ModelSerializer):
    def validate_items_input(self, value):
        if len(value) > MAX_PAYMENT_ITEMS:
            raise serializers.ValidationError(
                f'–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–æ–∑–∏—Ü–∏–π. –ú–∞–∫—Å–∏–º—É–º: {MAX_PAYMENT_ITEMS}'
            )
        return value

# llm_services/services/document_parser.py
MAX_INVOICE_ITEMS = 200

def _build_response(self, parsed_doc, from_cache=False):
    data = parsed_doc.parsed_data
    items = data.get('items', [])
    
    if len(items) > MAX_INVOICE_ITEMS:
        warnings.append(f'–°—á—ë—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç {len(items)} –ø–æ–∑–∏—Ü–∏–π. –ü–æ–∫–∞–∑–∞–Ω—ã –ø–µ—Ä–≤—ã–µ {MAX_INVOICE_ITEMS}.')
        data['items'] = items[:MAX_INVOICE_ITEMS]
    # ...
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° –°—Ä–µ–¥–Ω–∏–π  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –ù–∏–∑–∫–∞—è  
**–°—Ç–∞—Ç—É—Å:** üìã –ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è

---

### üü¢ –ü—Ä–æ–±–ª–µ–º–∞ 12: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤ –ø–æ–¥ —á–∞—Å—Ç—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã

**–û–ø–∏—Å–∞–Ω–∏–µ:**  
–ù–µ—Ç –∏–Ω–¥–µ–∫—Å–æ–≤ –ø–æ `status/created_at` –¥–ª—è `ParsedDocument`, –ø–æ `payment_type/status/date` –¥–ª—è `Payment`.

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑:**  
- ‚ùì **–≠—Ç–æ –ø—Ä–æ–±–ª–µ–º–∞ —Å–µ–π—á–∞—Å?** –ù–µ—Ç, –ø—Ä–∏ –º–∞–ª–æ–º –æ–±—ä—ë–º–µ –¥–∞–Ω–Ω—ã—Ö.
- ‚ùì **–ö–æ–≥–¥–∞ —Å—Ç–∞–Ω–µ—Ç –ø—Ä–æ–±–ª–µ–º–æ–π?** –ü—Ä–∏ 10,000+ –∑–∞–ø–∏—Å–µ–π.
- ‚ùì **–°—Ç–æ–∏—Ç –ª–∏ –¥–æ–±–∞–≤–ª—è—Ç—å –∑–∞—Ä–∞–Ω–µ–µ?** –î–∞, —ç—Ç–æ –Ω–µ —Å–ª–æ–∂–Ω–æ.

**–†–µ—à–µ–Ω–∏–µ:**

```python
# llm_services/models.py
class ParsedDocument(TimestampedModel):
    class Meta:
        indexes = [
            models.Index(fields=['file_hash']),  # —É–∂–µ –µ—Å—Ç—å
            models.Index(fields=['status']),
            models.Index(fields=['status', 'created_at']),  # –¥–ª—è cleanup
            models.Index(fields=['provider', 'created_at']),  # –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
        ]

# payments/models.py
class Payment(TimestampedModel):
    class Meta:
        indexes = [
            models.Index(fields=['payment_type', 'status']),
            models.Index(fields=['payment_date']),
            models.Index(fields=['status', 'payment_date']),
        ]
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü¢ –ù–∏–∑–∫–∏–π  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –ù–∏–∑–∫–∞—è  
**–°—Ç–∞—Ç—É—Å:** üìã –ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è

---

### üü° –ü—Ä–æ–±–ª–µ–º–∞ 13: –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–∏–ø–æ–≤ —Ñ–∞–π–ª–æ–≤ —Ç–æ–ª—å–∫–æ –ø–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—é

**–û–ø–∏—Å–∞–Ω–∏–µ:**  
–ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ `filename.endswith(...)`, –Ω–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ MIME/–º–∞–≥–∏—á–µ—Å–∫–∏—Ö –±–∞–π—Ç.

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑:**  
- ‚ùì **–≠—Ç–æ —Ä–µ–∞–ª—å–Ω–∞—è —É–≥—Ä–æ–∑–∞?** –î–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ‚Äî –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è. –î–ª—è –ø—É–±–ª–∏—á–Ω–æ–≥–æ ‚Äî –¥–∞.
- ‚ùì **–ß—Ç–æ –º–æ–∂–µ—Ç –ø–æ–π—Ç–∏ –Ω–µ —Ç–∞–∫?** –ó–∞–≥—Ä—É–∑–∫–∞ .exe —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º .pdf, —ç–∫—Å–ø–ª–æ–π—Ç—ã –≤ –ø–∞—Ä—Å–µ—Ä–∞—Ö.
- ‚ùì **–ö–∞–∫ –∑–∞—â–∏—Ç–∏—Ç—å—Å—è?** –ü—Ä–æ–≤–µ—Ä–∫–∞ magic bytes.

**–†–µ—à–µ–Ω–∏–µ:**

```python
# llm_services/views.py
import magic  # pip install python-magic

def validate_file_type(file_content: bytes, expected_extensions: list) -> tuple[bool, str]:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–∏–ø —Ñ–∞–π–ª–∞ –ø–æ magic bytes"""
    mime = magic.from_buffer(file_content[:1024], mime=True)
    
    allowed_mimes = {
        '.pdf': 'application/pdf',
        '.png': 'image/png',
        '.jpg': 'image/jpeg',
        '.jpeg': 'image/jpeg',
    }
    
    for ext in expected_extensions:
        if mime == allowed_mimes.get(ext):
            return True, mime
    
    return False, mime

# –í view:
is_valid, detected_mime = validate_file_type(file_content, ['.pdf', '.png', '.jpg', '.jpeg'])
if not is_valid:
    return Response(
        {'error': f'–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–∏–ø —Ñ–∞–π–ª–∞. –û–±–Ω–∞—Ä—É–∂–µ–Ω: {detected_mime}'},
        status=status.HTTP_400_BAD_REQUEST
    )
```

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å:** `python-magic` (—Ç—Ä–µ–±—É–µ—Ç libmagic)

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° –°—Ä–µ–¥–Ω–∏–π  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –ù–∏–∑–∫–∞—è  
**–°—Ç–∞—Ç—É—Å:** üìã –ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è

---

### üü¢ –ü—Ä–æ–±–ª–µ–º–∞ 14: –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ –ø–∞—Ä—Å–∏–Ω–≥–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ

**–û–ø–∏—Å–∞–Ω–∏–µ:**  
–û–±—â–∞—è 500 –±–µ–∑ trace-id –∏ –±–µ–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∫–æ–¥–æ–≤ –æ—à–∏–±–æ–∫.

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑:**  
- ‚ùì **–≠—Ç–æ –º–µ—à–∞–µ—Ç —Ä–∞–±–æ—Ç–µ?** –£—Å–ª–æ–∂–Ω—è–µ—Ç –æ—Ç–ª–∞–¥–∫—É –Ω–∞ –ø—Ä–æ–¥–µ.
- ‚ùì **–ù—É–∂–µ–Ω –ª–∏ trace-id?** –î–ª—è dev ‚Äî –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ, –¥–ª—è prod ‚Äî –∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ.
- ‚ùì **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—à–∏–±–æ–∫?** –•–æ—Ä–æ—à–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞, –Ω–æ –Ω–µ –±–ª–æ–∫–µ—Ä.

**–†–µ—à–µ–Ω–∏–µ (–ø–æ—ç—Ç–∞–ø–Ω–æ–µ):**

**–≠—Ç–∞–ø 1: –£–ª—É—á—à–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –æ—à–∏–±–æ–∫:**
```python
# llm_services/views.py
import uuid
import logging

logger = logging.getLogger(__name__)

def parse_invoice(request):
    request_id = str(uuid.uuid4())[:8]
    
    try:
        # ...
    except RateLimitError:
        logger.warning(f"[{request_id}] Rate limit exceeded")
        return Response({
            'success': False,
            'error_code': 'RATE_LIMIT',
            'error': '–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ LLM',
            'request_id': request_id
        }, status=429)
    except Exception as e:
        logger.exception(f"[{request_id}] Parse error: {e}")
        return Response({
            'success': False,
            'error_code': 'PARSE_ERROR',
            'error': str(e),
            'request_id': request_id
        }, status=500)
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü¢ –ù–∏–∑–∫–∏–π  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –ù–∏–∑–∫–∞—è  
**–°—Ç–∞—Ç—É—Å:** üìã –ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è

---

### üü° –ü—Ä–æ–±–ª–µ–º–∞ 15: –ù–µ—Ç –ø–ª–∞–Ω–æ–≤–æ–≥–æ cleanup –∫—ç—à–∞ –∏ ParsedDocument

**–û–ø–∏—Å–∞–Ω–∏–µ:**  
–ù–µ—Ç –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–π –æ—á–∏—Å—Ç–∫–∏ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –∑–∞–ø–∏—Å–µ–π/–∫—ç—à–µ–π.

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑:**  
- ‚ùì **–ö–æ–≥–¥–∞ —ç—Ç–æ —Å—Ç–∞–Ω–µ—Ç –ø—Ä–æ–±–ª–µ–º–æ–π?** –ß–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–µ—Å—è—Ü–µ–≤ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.
- ‚ùì **–°–∫–æ–ª—å–∫–æ –¥–∞–Ω–Ω—ã—Ö –Ω–∞–∫–∞–ø–ª–∏–≤–∞–µ—Ç—Å—è?** ~1 ParsedDocument + –∫—ç—à –Ω–∞ –∫–∞–∂–¥—ã–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª.
- ‚ùì **–ö–∞–∫ —Ä–µ—à–∏—Ç—å?** Management command + cron/celery beat.

**–†–µ—à–µ–Ω–∏–µ:**

```python
# llm_services/management/commands/cleanup_old_data.py
from django.core.management.base import BaseCommand
from django.utils import timezone
from django.core.cache import cache
from datetime import timedelta
from llm_services.models import ParsedDocument

class Command(BaseCommand):
    help = '–û—á–∏—Å—Ç–∫–∞ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö'
    
    def add_arguments(self, parser):
        parser.add_argument('--parsed-docs-days', type=int, default=90)
    
    def handle(self, *args, **options):
        # –û—á–∏—Å—Ç–∫–∞ ParsedDocument
        cutoff = timezone.now() - timedelta(days=options['parsed_docs_days'])
        deleted, _ = ParsedDocument.objects.filter(
            created_at__lt=cutoff,
            payment__isnull=True  # –ù–µ —É–¥–∞–ª—è–µ–º —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –ø–ª–∞—Ç–µ–∂–∞–º–∏
        ).delete()
        self.stdout.write(f'–£–¥–∞–ª–µ–Ω–æ ParsedDocument: {deleted}')
        
        # –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ ProductMatcher (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Redis)
        # cache.delete_pattern('product_matcher:*')  # –î–ª—è Redis
        # –î–ª—è LocMemCache ‚Äî –∫—ç—à –æ—á–∏—â–∞–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ
```

**Cron (–¥–æ–±–∞–≤–∏—Ç—å –≤ crontab):**
```bash
0 3 * * 0 cd /path/to/backend && python manage.py cleanup_old_data
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° –°—Ä–µ–¥–Ω–∏–π  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –ù–∏–∑–∫–∞—è  
**–°—Ç–∞—Ç—É—Å:** üìã –ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è

---

### üü¢ –ü—Ä–æ–±–ª–µ–º–∞ 16: ProductPriceHistory –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤

**–û–ø–∏—Å–∞–Ω–∏–µ:**  
–°–æ–∑–¥–∞—ë—Ç—Å—è –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ (–ø–æ –ø—Ä–æ–¥—É–∫—Ç—É+–∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç—É+–¥–∞—Ç–µ+–µ–¥–∏–Ω–∏—Ü–µ).

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑:**  
- ‚ùì **–≠—Ç–æ –ø—Ä–æ–±–ª–µ–º–∞?** –í–æ–∑–º–æ–∂–Ω—ã –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–µ —Ç–æ–≥–æ –∂–µ —Å—á—ë—Ç–∞.
- ‚ùì **–ö—Ä–∏—Ç–∏—á–Ω–æ –ª–∏?** –ù–µ—Ç, —ç—Ç–æ –∏—Å—Ç–æ—Ä–∏—è —Ü–µ–Ω ‚Äî –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–µ–π –∑–∞ –¥–µ–Ω—å –Ω–µ —Å—Ç—Ä–∞—à–Ω–æ.
- ‚ùì **–°—Ç–æ–∏—Ç –ª–∏ –∏—Å–ø—Ä–∞–≤–ª—è—Ç—å?** –ñ–µ–ª–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è —á–∏—Å—Ç–æ—Ç—ã –¥–∞–Ω–Ω—ã—Ö.

**–†–µ—à–µ–Ω–∏–µ:**

```python
# payments/services.py
ProductPriceHistory.objects.update_or_create(
    product=product,
    counterparty=counterparty,
    invoice_date=payment.payment_date,
    unit=item_data.get('unit', '—à—Ç'),
    defaults={
        'price': price_per_unit,
        'invoice_number': payment.description or '',
        'payment': payment
    }
)
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü¢ –ù–∏–∑–∫–∏–π  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –¢—Ä–∏–≤–∏–∞–ª—å–Ω–∞—è  
**–°—Ç–∞—Ç—É—Å:** üìã –ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è

---

### üü° –ü—Ä–æ–±–ª–µ–º–∞ 17: –ù–µ—Ç rate limiting –Ω–∞ /llm/parse-invoice/

**–û–ø–∏—Å–∞–Ω–∏–µ:**  
–ù–µ—Ç throttling –Ω–∞ —Ç—è–∂—ë–ª—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç ‚Üí —Ä–∏—Å–∫ –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è.

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑:**  
- ‚ùì **–†–µ–∞–ª–µ–Ω –ª–∏ —Ä–∏—Å–∫?** –î–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ‚Äî –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π.
- ‚ùì **–ö–∞–∫–æ–≤ —É—â–µ—Ä–±?** –†–∞—Å—Ö–æ–¥ —Ç–æ–∫–µ–Ω–æ–≤ LLM ($$$), –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä.
- ‚ùì **–ö–∞–∫ –∑–∞—â–∏—Ç–∏—Ç—å—Å—è?** DRF throttling.

**–†–µ—à–µ–Ω–∏–µ:**

```python
# finans_assistant/settings.py
REST_FRAMEWORK = {
    # ...
    'DEFAULT_THROTTLE_CLASSES': [
        'rest_framework.throttling.UserRateThrottle',
    ],
    'DEFAULT_THROTTLE_RATES': {
        'user': '100/hour',  # –û–±—â–∏–π –ª–∏–º–∏—Ç
        'llm_parse': '20/hour',  # –î–ª—è LLM-–ø–∞—Ä—Å–∏–Ω–≥–∞
    }
}

# llm_services/views.py
from rest_framework.throttling import UserRateThrottle

class LLMParseThrottle(UserRateThrottle):
    rate = '20/hour'

@api_view(['POST', 'OPTIONS'])
@throttle_classes([LLMParseThrottle])
def parse_invoice(request):
    # ...
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° –°—Ä–µ–¥–Ω–∏–π  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –ù–∏–∑–∫–∞—è  
**–°—Ç–∞—Ç—É—Å:** üìã –ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è

---

### üü° –ü—Ä–æ–±–ª–µ–º–∞ 18: –ù–µ—Ç —è–≤–Ω—ã—Ö —Ç–∞–π–º–∞—É—Ç–æ–≤ HTTP-–∫–ª–∏–µ–Ω—Ç–æ–≤ LLM

**–û–ø–∏—Å–∞–Ω–∏–µ:**  
–ù–µ—Ç —è–≤–Ω—ã—Ö —Ç–∞–π–º–∞—É—Ç–æ–≤ –Ω–∞ —É—Ä–æ–≤–Ω–µ HTTP-–∫–ª–∏–µ–Ω—Ç–∞/SDK.

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑:**  
- ‚ùì **–≠—Ç–æ —Ç–∞ –∂–µ –ø—Ä–æ–±–ª–µ–º–∞ —á—Ç–æ #5?** –ß–∞—Å—Ç–∏—á–Ω–æ –¥–∞, –Ω–æ #5 ‚Äî –ø—Ä–æ retry, —Ç—É—Ç ‚Äî –ø—Ä–æ —Ç–∞–π–º–∞—É—Ç—ã.
- ‚ùì **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ?** –û–±—ä–µ–¥–∏–Ω–∏—Ç—å —Å #5.

**–†–µ—à–µ–Ω–∏–µ:** –°–º. –ü—Ä–æ–±–ª–µ–º—É #5.

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –û–±—ä–µ–¥–∏–Ω–µ–Ω–æ —Å #5  
**–°—Ç–∞—Ç—É—Å:** üìã –ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è

---

### üü° –ü—Ä–æ–±–ª–µ–º–∞ 19: –ù–µ—Ç –æ—á–∏—Å—Ç–∫–∏ —Ñ–∞–π–ª–æ–≤ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ Payment/ParsedDocument

**–û–ø–∏—Å–∞–Ω–∏–µ:**  
–§–∞–π–ª—ã –æ—Å—Ç–∞—é—Ç—Å—è –Ω–∞ –¥–∏—Å–∫–µ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–µ–π.

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑:**  
- ‚ùì **–≠—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ?** –ù–µ—Ç, –Ω–æ –Ω–∞–∫–∞–ø–ª–∏–≤–∞–µ—Ç—Å—è –º—É—Å–æ—Ä.
- ‚ùì **–£–∂–µ —Ä–µ—à–µ–Ω–æ —Ä–∞–Ω–µ–µ?** –í REFACTORING_REPORT.md —É–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è `core/file_signals.py`.
- ‚ùì **–†–∞–±–æ—Ç–∞–µ—Ç –ª–∏ –¥–ª—è –Ω–æ–≤—ã—Ö –º–æ–¥–µ–ª–µ–π?** –ù—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å.

**–†–µ—à–µ–Ω–∏–µ:**

```python
# core/file_signals.py ‚Äî –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –º–æ–¥–µ–ª–∏
from llm_services.models import ParsedDocument

@receiver(post_delete, sender=ParsedDocument)
def delete_parsed_document_file(sender, instance, **kwargs):
    if instance.file:
        instance.file.delete(save=False)
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° –°—Ä–µ–¥–Ω–∏–π  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –¢—Ä–∏–≤–∏–∞–ª—å–Ω–∞—è  
**–°—Ç–∞—Ç—É—Å:** üìã –ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è

---

### ‚è∏Ô∏è –ü—Ä–æ–±–ª–µ–º–∞ 20: –ù–µ—Ç –∞–Ω—Ç–∏–≤–∏—Ä—É—Å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ–∞–π–ª–æ–≤

**–û–ø–∏—Å–∞–Ω–∏–µ:**  
–ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º—ã—Ö PDF/–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –Ω–∞ –≤–∏—Ä—É—Å—ã.

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑:**  
- ‚ùì **–≠—Ç–æ —Ä–µ–∞–ª—å–Ω–∞—è —É–≥—Ä–æ–∑–∞ –¥–ª—è dev?** –ù–µ—Ç.
- ‚ùì **–ù—É–∂–Ω–æ –ª–∏ –¥–ª—è prod?** –ñ–µ–ª–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –ø—É–±–ª–∏—á–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤.
- ‚ùì **–°–ª–æ–∂–Ω–æ—Å—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏?** –í—ã—Å–æ–∫–∞—è (ClamAV, VirusTotal API).
- ‚ùì **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç?** –ù–∏–∑–∫–∏–π –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

**–†–µ—à–µ–Ω–∏–µ (–æ—Ç–ª–æ–∂–µ–Ω–æ –¥–æ prod):**

```python
# –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ ‚Äî –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å ClamAV
import clamd

def scan_file(file_content: bytes) -> tuple[bool, str]:
    cd = clamd.ClamdUnixSocket()
    result = cd.instream(io.BytesIO(file_content))
    status = result['stream'][0]
    if status == 'OK':
        return True, None
    return False, result['stream'][1]
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** ‚è∏Ô∏è –û—Ç–ª–æ–∂–µ–Ω–æ  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –í—ã—Å–æ–∫–∞—è  
**–°—Ç–∞—Ç—É—Å:** ‚è∏Ô∏è –ù–µ –ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è (dev)

---

## ‚úÖ –í–´–ü–û–õ–ù–ï–ù–ù–´–ï –ò–ó–ú–ï–ù–ï–ù–ò–Ø

### –≠—Ç–∞–ø 1: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã ‚Äî ‚úÖ –ó–ê–í–ï–†–®–Å–ù

| # | –ü—Ä–æ–±–ª–µ–º–∞ | –î–µ–π—Å—Ç–≤–∏–µ | –°—Ç–∞—Ç—É—Å |
|---|----------|----------|--------|
| 1 | –ù–µ–ø—Ä–∏–º–µ–Ω—ë–Ω–Ω—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏ | –ü—Ä–∏–º–µ–Ω–µ–Ω—ã –º–∏–≥—Ä–∞—Ü–∏–∏ contracts, objects | ‚úÖ |
| 4 | –ù–µ—Ç –ª–∏–º–∏—Ç–∞ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–æ–≤ | 10MB + 20 —Å—Ç—Ä–∞–Ω–∏—Ü PDF | ‚úÖ |
| 10 | –ú–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è queryset | –ù–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ (false positive) | ‚úÖ |

### –≠—Ç–∞–ø 2: –°—Ä–µ–¥–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã ‚Äî ‚úÖ –ó–ê–í–ï–†–®–Å–ù

| # | –ü—Ä–æ–±–ª–µ–º–∞ | –î–µ–π—Å—Ç–≤–∏–µ | –°—Ç–∞—Ç—É—Å |
|---|----------|----------|--------|
| 2 | Race condition –ø–∞—Ä—Å–∏–Ω–≥–∞ | select_for_update + PENDING timeout | ‚úÖ |
| 5+18 | –¢–∞–π–º–∞—É—Ç—ã LLM | 120 —Å–µ–∫ –¥–ª—è –≤—Å–µ—Ö –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ | ‚úÖ |
| 9 | NULL —Å—É–º–º—ã –≤ –ø–ª–∞—Ç–µ–∂–∞—Ö | fill_payment_amounts command | ‚úÖ |
| 11 | –õ–∏–º–∏—Ç –ø–æ–∑–∏—Ü–∏–π | MAX_PAYMENT_ITEMS = 200 | ‚úÖ |
| 13 | –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–∏–ø–∞ —Ñ–∞–π–ª–∞ | magic bytes –ø—Ä–æ–≤–µ—Ä–∫–∞ | ‚úÖ |
| 17 | Rate limiting | LLMParseThrottle 30/hour | ‚úÖ |

### –≠—Ç–∞–ø 3: –ù–∏–∑–∫–æ–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è ‚Äî ‚úÖ –ó–ê–í–ï–†–®–Å–ù

| # | –ü—Ä–æ–±–ª–µ–º–∞ | –î–µ–π—Å—Ç–≤–∏–µ | –°—Ç–∞—Ç—É—Å |
|---|----------|----------|--------|
| 3 | retry_count | –ü–æ–ª–µ + –ª–æ–≥–∏–∫–∞ MAX_PARSE_ATTEMPTS=3 | ‚úÖ |
| 6 | –î–µ—Ç–µ—Ä–º–∏–Ω–∏–∑–º default | order_by('pk') + DoesNotExist | ‚úÖ |
| 7+15 | Retention –¥–∞–Ω–Ω—ã—Ö | cleanup_old_data command | ‚úÖ |
| 12 | –ò–Ω–¥–µ–∫—Å—ã | status+created_at, provider+created_at | ‚úÖ |
| 14 | –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ | request_id + error_code | ‚úÖ |
| 16 | –î—É–±–ª–∏–∫–∞—Ç—ã PriceHistory | update_or_create | ‚úÖ |
| 19 | –û—á–∏—Å—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤ | ParsedDocument –≤ file_signals | ‚úÖ |

### –£—Å–ª–æ–≤–Ω–æ —Ä–µ—à—ë–Ω–Ω—ã–µ / –û—Ç–ª–æ–∂–µ–Ω–Ω—ã–µ

| # | –ü—Ä–æ–±–ª–µ–º–∞ | –°—Ç–∞—Ç—É—Å |
|---|----------|--------|
| 8 | CORS prod | ‚úÖ –ó–∞–≤–∏—Å–∏—Ç –æ—Ç DEBUG |
| 20 | –ê–Ω—Ç–∏–≤–∏—Ä—É—Å | ‚è∏Ô∏è –û—Ç–ª–æ–∂–µ–Ω–æ (dev) |

---

## üìä –û–¶–ï–ù–ö–ê –¢–†–£–î–û–ó–ê–¢–†–ê–¢

| –≠—Ç–∞–ø | –ü—Ä–æ–±–ª–µ–º—ã | –û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ |
|------|----------|----------------|
| –≠—Ç–∞–ø 1 (–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ) | 1, 4, 10 | 2-4 —á–∞—Å–∞ |
| –≠—Ç–∞–ø 2 (–°—Ä–µ–¥–Ω–∏–µ) | 2, 5, 9, 11, 13, 17, 18 | 1-2 –¥–Ω—è |
| –≠—Ç–∞–ø 3 (–£–ª—É—á—à–µ–Ω–∏—è) | 3, 6, 7, 12, 14, 15, 16, 19 | 1 –¥–µ–Ω—å |
| **–ò—Ç–æ–≥–æ** | 18 –ø—Ä–æ–±–ª–µ–º | **2-4 –¥–Ω—è** |

---

## üîç –ó–ê–í–ò–°–ò–ú–û–°–¢–ò

```
–ü—Ä–æ–±–ª–µ–º–∞ 10 ‚Üí –ü—Ä–æ–±–ª–µ–º–∞ 9 (–æ–±–µ —Å–≤—è–∑–∞–Ω—ã —Å Payment queryset)
–ü—Ä–æ–±–ª–µ–º–∞ 5 = –ü—Ä–æ–±–ª–µ–º–∞ 18 (–æ–±—ä–µ–¥–∏–Ω–∏—Ç—å)
–ü—Ä–æ–±–ª–µ–º–∞ 7 ‚Üí –ü—Ä–æ–±–ª–µ–º–∞ 15 (–æ–±–µ –ø—Ä–æ retention)
–ü—Ä–æ–±–ª–µ–º–∞ 3 ‚Üí –ü—Ä–æ–±–ª–µ–º–∞ 2 (retry –ø–æ—Å–ª–µ race condition)
```

---

## üìä –ò–¢–û–ì–û–í–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê

| –ú–µ—Ç—Ä–∏–∫–∞ | –ó–Ω–∞—á–µ–Ω–∏–µ |
|---------|----------|
| –ü—Ä–æ–±–ª–µ–º –≤—ã—è–≤–ª–µ–Ω–æ | 20 |
| –ü—Ä–æ–±–ª–µ–º —Ä–µ—à–µ–Ω–æ | 18 |
| –ü—Ä–æ–±–ª–µ–º –æ—Ç–ª–æ–∂–µ–Ω–æ | 1 (–∞–Ω—Ç–∏–≤–∏—Ä—É—Å) |
| –ü—Ä–æ–±–ª–µ–º –∑–∞–∫—Ä—ã—Ç–æ —É—Å–ª–æ–≤–Ω–æ | 1 (CORS) |
| –¢–µ—Å—Ç–æ–≤ –ø—Ä–æ–π–¥–µ–Ω–æ | 135/135 ‚úÖ |

### –ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã:
- `llm_services/management/commands/cleanup_old_data.py`
- `llm_services/migrations/0002_add_retry_count.py`
- `llm_services/migrations/0003_add_indexes.py`
- `payments/management/commands/fill_payment_amounts.py`

### –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:
- `llm_services/views.py` ‚Äî rate limiting, magic bytes, –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- `llm_services/services/document_parser.py` ‚Äî race condition, retry_count
- `llm_services/models.py` ‚Äî retry_count, –∏–Ω–¥–µ–∫—Å—ã
- `llm_services/providers/*.py` ‚Äî —Ç–∞–π–º–∞—É—Ç—ã
- `payments/serializers.py` ‚Äî –ª–∏–º–∏—Ç –ø–æ–∑–∏—Ü–∏–π
- `payments/services.py` ‚Äî update_or_create
- `finans_assistant/settings.py` ‚Äî CORS –ø–æ DEBUG
- `core/file_signals.py` ‚Äî ParsedDocument cleanup

---

*–î–æ–∫—É–º–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω: 04.01.2026*  
*–û–±–Ω–æ–≤–ª–µ–Ω–æ: 04.01.2026*
