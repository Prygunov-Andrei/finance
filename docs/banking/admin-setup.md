# Руководство администратора: Настройка банковского модуля

Руководство по первичной настройке банковской интеграции с Точка Банком.

---

## Содержание

1. [Создание приложения в личном кабинете Точки](#1-создание-приложения-в-личном-кабинете-точки)
2. [Добавление банковского подключения](#2-добавление-банковского-подключения)
3. [Привязка банковских счетов к внутренним](#3-привязка-банковских-счетов-к-внутренним)
4. [Режим платежей](#4-режим-платежей)
5. [Настройка вебхуков](#5-настройка-вебхуков)
6. [Проверка подключения](#6-проверка-подключения)
7. [Генерация BANK_ENCRYPTION_KEY](#7-генерация-bank_encryption_key)

---

## 1. Создание приложения в личном кабинете Точки

### Шаги

1. Войдите в **личный кабинет Точка Банка** на [enter.tochka.com](https://enter.tochka.com).
2. Перейдите в раздел **Интеграции** или **API**.
3. Создайте новое приложение:
   - Укажите название (например: «Finans Assistant»);
   - Выберите нужные права доступа (accounts, balances, payments);
   - Согласуйте условия использования API.
4. После создания приложения получите:
   - **Client ID** — идентификатор приложения;
   - **Client Secret** — секретный ключ (храните в безопасности).

### Документация Точки

- [Точка.API — документация](https://enter.tochka.com/doc/v2/redoc)
- [Документация Open API](https://developers.tochka.com/docs/tochka-api/)

### Sandbox

Для тестирования можно использовать sandbox-контур Точки. В этом случае используйте отдельные credentials для sandbox.

---

## 2. Добавление банковского подключения

### Через интерфейс

1. Перейдите в **Настройки** → вкладка **Банковские подключения**.
2. Нажмите **Добавить подключение**.
3. Заполните форму:
   - **Название** — например: «Точка — основной счёт ООО Август»;
   - **Юридическое лицо** — выберите компанию из справочника;
   - **Client ID** — из личного кабинета Точки;
   - **Client Secret** — из личного кабинета Точки;
   - **Customer Code** — идентификатор клиента в банке (можно получить после синхронизации счетов);
   - **Режим платежей** — см. [раздел 4](#4-режим-платежей);
   - **Подключение активно** — включите.

4. Сохраните.

### Через API

```http
POST /api/v1/bank-connections/
Content-Type: application/json

{
  "name": "Точка — основной счёт ООО Август",
  "legal_entity": 1,
  "provider": "tochka",
  "client_id": "your_client_id",
  "client_secret": "your_client_secret",
  "customer_code": "optional_customer_code",
  "payment_mode": "for_sign",
  "is_active": true
}
```

### Безопасность

- Credentials хранятся в БД в **зашифрованном виде** (Fernet, AES-128-CBC);
- Ключ шифрования задаётся в `BANK_ENCRYPTION_KEY` (см. [раздел 7](#7-генерация-bank_encryption_key)).

---

## 3. Привязка банковских счетов к внутренним

### Предварительные условия

1. В системе созданы **внутренние счета** (Account) в разделе «Счета» настроек.
2. Добавлено **банковское подключение** (BankConnection).

### Синхронизация списка счетов

1. Откройте банковское подключение.
2. Выполните действие **Подтянуть список счетов** (sync-accounts) — через API или UI, если реализовано.

```http
POST /api/v1/bank-connections/{id}/sync-accounts/
```

Ответ содержит список счетов из банка с `accountId`.

### Создание привязки BankAccount

Привязка связывает внутренний `Account` с `external_account_id` из банка.

```http
POST /api/v1/bank-accounts/
Content-Type: application/json

{
  "account": 1,
  "bank_connection": 1,
  "external_account_id": "account_id_from_bank",
  "sync_enabled": true
}
```

**Поля:**

- `account` — ID внутреннего счёта (Account);
- `bank_connection` — ID банковского подключения;
- `external_account_id` — ID счёта в банке (из sync-accounts);
- `sync_enabled` — включить автоматическую синхронизацию выписок (по умолчанию true).

### Важно

- Один внутренний счёт может быть привязан только к одному банковскому счёту (OneToOne).
- Номер внутреннего счёта (Account.number) должен соответствовать номеру расчётного счёта в банке для корректного отображения.

---

## 4. Режим платежей

При создании/редактировании подключения выбирается режим:

| Режим | Код | Описание |
|-------|-----|----------|
| **Черновик (подпись через банк)** | `for_sign` | Платёж создаётся в банке как черновик. Требуется подпись в личном кабинете банка. Статус в системе: «Ожидает подписи» → после подписи «Исполнено». |
| **Автоподпись через API** | `auto_sign` | Платёж создаётся и подписывается автоматически через API. Сразу переходит в «Исполнено». |

### Когда что выбирать

- **for_sign** — если требуется двухфакторная подпись (руководитель подписывает в ЛК банка);
- **auto_sign** — если настроено автоматическое подписание в банке и нужна полная автоматизация.

---

## 5. Настройка вебхуков

Вебхуки позволяют получать уведомления о входящих и исходящих платежах в реальном времени.

### URL вебхука

```
https://your-domain.com/api/v1/banking/webhook/tochka/
```

### Регистрация в Точке

1. В личном кабинете Точки найдите раздел настройки вебхуков.
2. Укажите URL вашего вебхука.
3. Сохраните.

### Обработка

- Вебхук принимает POST-запрос с JWT в теле;
- Подпись верифицируется публичным ключом Точки (RS256);
- Поддерживаемые типы: `incomingPayment`, `outgoingPayment`;
- При получении создаётся `BankTransaction` и при необходимости обновляется статус `BankPaymentOrder`.

### Важно

- Endpoint **публичный** (без JWT-авторизации Django) — банк не отправляет заголовки авторизации;
- Верификация выполняется по криптографической подписи JWT.

---

## 6. Проверка подключения

### Тест подключения

1. В карточке банковского подключения нажмите **Тест подключения**.
2. Или выполните:

```http
POST /api/v1/bank-connections/{id}/test/
```

При успехе: `{"status": "ok", "message": "Подключение успешно"}`.

При ошибке: `{"status": "error", "message": "текст ошибки"}`.

### Что проверяется

- Получение `access_token` по client_id/client_secret (OAuth2 client_credentials);
- Корректность credentials.

### Ручная синхронизация выписки

Для проверки доступа к выписке:

```http
POST /api/v1/bank-accounts/{id}/sync-statements/
Content-Type: application/json

{
  "date_from": "2026-01-01",
  "date_to": "2026-02-12"
}
```

Опционально: `date_from` и `date_to` в формате `YYYY-MM-DD`. Если не указаны — последние 30 дней.

---

## 7. Генерация BANK_ENCRYPTION_KEY

Credentials банка (client_id, client_secret, access_token, refresh_token) шифруются в БД. Для шифрования используется Fernet (AES-128-CBC).

### Генерация ключа

```bash
python -c "from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())"
```

Пример вывода: `xK8j2...` (base64-строка 44 символа).

### Добавление в .env

1. Скопируйте сгенерированный ключ.
2. Добавьте в файл `.env`:

```env
# Banking Encryption (шифрование банковских секретов)
BANK_ENCRYPTION_KEY=ваш_сгенерированный_ключ
```

3. Перезапустите приложение.

### Важно

- **Не меняйте ключ** после сохранения credentials — расшифровка старых данных станет невозможной;
- Храните ключ в безопасном месте (secrets manager);
- При ротации ключа потребуется пересоздание банковских подключений с новыми credentials.
