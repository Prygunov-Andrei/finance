# Руководство контролёра: Одобрение платежей

Руководство для контролёра — сотрудника, который одобряет или отклоняет платёжные поручения, назначает даты оплаты и управляет отправкой в банк.

---

## Содержание

1. [Одобрение или отклонение платежа](#1-одобрение-или-отклонение-платежа)
2. [Назначение даты оплаты при одобрении](#2-назначение-даты-оплаты-при-одобрении)
3. [Перенос даты оплаты](#3-перенос-даты-оплаты)
4. [Просмотр истории действий (аудит-лог)](#4-просмотр-истории-действий-аудит-лог)
5. [Ручная отправка в банк](#5-ручная-отправка-в-банк)
6. [Автоматическое исполнение (Celery)](#6-автоматическое-исполнение-celery)

---

## 1. Одобрение или отклонение платежа

### Как одобрить

1. Перейдите в раздел **Платёжные поручения**.
2. Отфильтруйте по статусу **На согласовании**.
3. Откройте поручение (клик по строке в таблице).
4. Нажмите кнопку **Одобрить**.

После одобрения платёж перейдёт в статус **Одобрено** и будет ожидать наступления даты оплаты (или ручной отправки).

### Как отклонить

1. Откройте поручение в статусе **На согласовании**.
2. Нажмите кнопку **Отклонить**.
3. Укажите **комментарий** с причиной отклонения (рекомендуется).

Отклонённый платёж переходит в статус **Отклонено** и не может быть изменён. Оператор может создать новое поручение при необходимости.

---

## 2. Назначение даты оплаты при одобрении

При одобрении можно указать **новую дату оплаты**, отличную от предложенной оператором.

**Пример:** Оператор указал дату «15.03.2026», но вы хотите запланировать оплату на «20.03.2026».

В API передаётся параметр `payment_date` в формате `YYYY-MM-DD`. Если на фронтенде форма одобрения поддерживает выбор даты — выберите нужную дату перед нажатием «Одобрить».

**Примечание:** Если дата не указана, используется дата из исходного поручения.

---

## 3. Перенос даты оплаты

Перенос даты возможен **только для поручений в статусе «Одобрено»**.

### Порядок действий

1. Откройте одобренное платёжное поручение.
2. Нажмите **Перенести дату**.
3. Укажите **новую дату**.
4. **Обязательно** укажите **причину переноса** в комментарии.

Без комментария система не позволит выполнить перенос — это требование для аудита.

### Пример комментария

> «Перенос по просьбе поставщика — ожидаем поступление товара до 25.03.2026»

### Ограничения

- Перенос возможен **многократно** до момента отправки в банк;
- Количество переносов отображается в карточке поручения (бейдж «перенесено Nx»);
- Изначальная дата (`original_payment_date`) сохраняется для истории.

---

## 4. Просмотр истории действий (аудит-лог)

В карточке платёжного поручения отображается **история действий** (таймлайн).

### Типы событий

| Событие | Описание |
|---------|----------|
| **Создано** | Оператор создал поручение |
| **Отправлено на согласование** | Оператор отправил на согласование |
| **Одобрено** | Контролёр одобрил (с указанием даты) |
| **Отклонено** | Контролёр отклонил |
| **Перенос даты оплаты** | Контролёр перенёс дату (старая → новая) |
| **Отправлено в банк** | Поручение отправлено в банк |
| **Исполнено** | Банк исполнил платёж |
| **Ошибка** | Ошибка при отправке или отклонение банком |
| **Комментарий** | Произвольный комментарий |

### Что отображается

- **Пользователь** — кто выполнил действие;
- **Дата и время** — когда;
- **Детали** — для переноса: старая и новая дата;
- **Комментарий** — причина переноса или отклонения.

---

## 5. Ручная отправка в банк

Одобренные платежи могут отправляться в банк **двумя способами**:

1. **Автоматически** — Celery-задача выполняет платежи в день наступления даты (см. раздел 6).
2. **Вручную** — контролёр отправляет платёж до наступления даты.

### Как отправить вручную

1. Откройте поручение в статусе **Одобрено**.
2. Нажмите **Отправить в банк**.

Платёж будет отправлен в банк **немедленно**, независимо от даты оплаты.

**Применение:** когда нужно срочно оплатить счёт до запланированной даты.

### Режимы работы с банком

- **Черновик (подпись через банк):** платёж создаётся в банке как черновик → статус «Ожидает подписи» → требуется подпись в ЛК банка.
- **Автоподпись через API:** платёж сразу исполняется → статус «Исполнено».

---

## 6. Автоматическое исполнение (Celery)

### Задача `execute_scheduled_payments`

Периодическая задача Celery **каждые 15 минут** выполняет следующее:

1. Выбирает все платёжные поручения в статусе **Одобрено**;
2. У которых **дата оплаты наступила или уже прошла** (`payment_date <= сегодня`);
3. С активным банковским подключением.

Для каждого такого поручения вызывается `execute_payment_order` — отправка в банк.

### Расписание (Celery Beat)

```python
'banking-execute-scheduled-payments': {
    'task': 'banking.execute_scheduled_payments',
    'schedule': 900.0,  # каждые 15 минут
}
```

### Учёт переносов

Задача использует **актуальную** `payment_date` — т.е. после переноса даты оплаты берётся новая дата, а не исходная.

### Связанные задачи

| Задача | Расписание | Назначение |
|--------|------------|------------|
| `sync_all_statements` | 30 мин | Синхронизация выписок |
| `execute_scheduled_payments` | 15 мин | Исполнение одобренных платежей |
| `refresh_bank_tokens` | 12 часов | Обновление access_token |
| `check_pending_payments` | 5 мин | Проверка статуса отправленных платежей в банке |

---

## Сводка действий контролёра

| Действие | Статус поручения | Результат |
|----------|------------------|-----------|
| Одобрить | На согласовании | → Одобрено |
| Отклонить | На согласовании | → Отклонено |
| Перенести дату | Одобрено | Новая дата оплаты |
| Отправить в банк | Одобрено | → Отправлено в банк / Исполнено |
