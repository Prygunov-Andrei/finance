# Работа с банковскими выписками

Руководство по синхронизации выписок, сопоставлению транзакций с внутренними платежами и фильтрации.

---

## Содержание

1. [Автоматическая синхронизация выписок](#1-автоматическая-синхронизация-выписок)
2. [Ручная синхронизация](#2-ручная-синхронизация)
3. [Сопоставление транзакций (reconciliation)](#3-сопоставление-транзакций-reconciliation)
4. [Фильтрация и поиск](#4-фильтрация-и-поиск)

---

## 1. Автоматическая синхронизация выписок

### Celery-задача `sync_all_statements`

Периодическая задача **каждые 30 минут** синхронизирует выписки по всем активным банковским счетам.

### Условия

Синхронизация выполняется только для счетов, у которых:

- `sync_enabled = True`;
- `bank_connection.is_active = True`.

### Алгоритм

1. Для каждого активного BankAccount вызывается `sync_statements(bank_account)`.
2. Период по умолчанию:
   - `date_from` = `last_statement_date` или (сегодня − 30 дней);
   - `date_to` = сегодня.
3. Запрос к API банка (Точка) за выпиской.
4. Парсинг транзакций, создание `BankTransaction` для новых операций.
5. Обновление `last_statement_date` на bank_account и `last_sync_at` на connection.

### Расписание (Celery Beat)

```python
'banking-sync-statements': {
    'task': 'banking.sync_all_statements',
    'schedule': 1800.0,  # каждые 30 минут
}
```

### Отключение автосинхронизации

При редактировании BankAccount установите `sync_enabled = False` — счёт будет исключён из задачи `sync_all_statements`.

---

## 2. Ручная синхронизация

### Через интерфейс

1. Перейдите в раздел **Банковские выписки**.
2. Выберите **банковский счёт** в filtре.
3. Нажмите **Синхронизировать**.

Система запросит выписку за период (по умолчанию — последние 30 дней или с даты последней синхронизации).

### Через API

```http
POST /api/v1/bank-accounts/{id}/sync-statements/
Content-Type: application/json

{
  "date_from": "2026-01-01",
  "date_to": "2026-02-12"
}
```

**Параметры (опционально):**

- `date_from` — начало периода (YYYY-MM-DD);
- `date_to` — конец периода (YYYY-MM-DD).

Если не указаны — используются значения по умолчанию (см. выше).

**Ответ при успехе:**

```json
{
  "status": "ok",
  "new_transactions": 15
}
```

---

## 3. Сопоставление транзакций (reconciliation)

Сопоставление (reconciliation) — привязка банковской транзакции к внутреннему платежу (Payment).

### Зачем нужно

- Связь банковской операции с документом в системе;
- Отслеживание оплаченных счетов;
- Контроль соответствия выписки и учёта.

### Как сопоставить

1. Перейдите в **Банковские выписки**.
2. Найдите транзакцию со статусом **Не сверено**.
3. Нажмите кнопку привязки (иконка ссылки) у нужной транзакции.
4. В диалоге введите **ID внутреннего платежа**.
5. Нажмите **Привязать**.

### Через API

```http
POST /api/v1/bank-transactions/{id}/reconcile/
Content-Type: application/json

{
  "payment_id": 123
}
```

**Результат:**

- `transaction.payment_id` = 123;
- `transaction.reconciled` = True.

### Автоматическая сверка

В сервисном слое реализована функция `auto_reconcile(bank_account)` — сопоставление по:

- Сумме;
- Дате;
- ИНН контрагента (если есть);
- Статус платежа = `paid`.

Если найден ровно один подходящий платёж — транзакция автоматически привязывается. В текущей версии эта функция не вызывается из UI или периодических задач — может использоваться как management-команда или вручную.

---

## 4. Фильтрация и поиск

### Раздел «Банковские выписки»

Доступны следующие фильтры:

| Фильтр | Описание | Значения |
|--------|----------|----------|
| **Банковский счёт** | Выбор счёта | Все счета / конкретный счёт |
| **Тип транзакции** | Направление | Все / Входящие / Исходящие |
| **Статус сверки** | Сверено или нет | Все / Сверено / Не сверено |
| **Поиск** | Полнотекстовый поиск | По контрагенту, ИНН, назначению платежа |

### API-параметры

```http
GET /api/v1/bank-transactions/?bank_account=1&transaction_type=outgoing&reconciled=false&search=ООО
```

**Параметры запроса:**

- `bank_account` — ID банковского счёта;
- `transaction_type` — `incoming` или `outgoing`;
- `reconciled` — `true` / `false`;
- `date` — фильтр по дате;
- `search` — поиск по `counterparty_name`, `counterparty_inn`, `purpose`;
- `ordering` — сортировка (например: `-date`, `amount`).

### Сортировка по умолчанию

Транзакции сортируются по дате по убыванию (`-date`) — самые новые сверху.

---

## Поля банковской транзакции

| Поле | Описание |
|------|----------|
| `external_id` | ID платежа в банке |
| `transaction_type` | Входящий / Исходящий |
| `amount` | Сумма |
| `date` | Дата операции |
| `purpose` | Назначение платежа |
| `counterparty_name` | Наименование контрагента |
| `counterparty_inn` | ИНН контрагента |
| `counterparty_kpp` | КПП контрагента |
| `counterparty_account` | Счёт контрагента |
| `counterparty_bank_name` | Банк контрагента |
| `counterparty_bik` | БИК банка контрагента |
| `counterparty_corr_account` | Корр. счёт банка контрагента |
| `document_number` | Номер документа |
| `payment` | Связанный внутренний платёж (после сверки) |
| `reconciled` | Флаг сверки |
