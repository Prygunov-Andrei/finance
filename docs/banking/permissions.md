# Права доступа: Банковский модуль

Описание разделов прав доступа, связанных с банковскими операциями и одобрением платежей.

---

## Содержание

1. [Раздел «Банковские операции»](#1-раздел-банковские-операции)
2. [Раздел «Одобрение платежей»](#2-раздел-одобрение-платежей)
3. [Назначение прав через модуль Персонал](#3-назначение-прав-через-модуль-персонал)
4. [Разделение ролей: оператор и контролёр](#4-разделение-ролей-оператор-и-контролёр)

---

## 1. Раздел «Банковские операции»

**Код раздела:** `banking`

Определяет доступ к банковским подключениям, счетам, транзакциям и платёжным поручениям.

### Уровни доступа

| Уровень | Код | Права |
|---------|-----|-------|
| **Нет доступа** | `none` | Нет доступа к разделу. API-запросы к `/api/v1/bank-connections/`, `/api/v1/bank-accounts/`, `/api/v1/bank-transactions/`, `/api/v1/bank-payment-orders/` возвращают 403. |
| **Чтение** | `read` | Просмотр списков и деталей: подключения, счета, транзакции, платёжные поручения. GET, HEAD, OPTIONS разрешены. Создание и редактирование запрещены. |
| **Редактирование** | `edit` | Полный доступ: создание, изменение, удаление, все действия (submit, approve, reject, reschedule, execute). |

### Какие API затрагиваются

- `/api/v1/bank-connections/` — банковские подключения;
- `/api/v1/bank-accounts/` — привязки банковских счетов;
- `/api/v1/bank-transactions/` — банковские транзакции (выписки);
- `/api/v1/bank-payment-orders/` — платёжные поручения.

### Логика проверки

- **GET, HEAD, OPTIONS** → требуются `read` или `edit`;
- **POST, PUT, PATCH, DELETE** → требуется `edit`.

---

## 2. Раздел «Одобрение платежей»

**Код раздела:** `banking_approve`

Отдельный раздел для контроля действий по одобрению/отклонению платежей.

### Уровни доступа

| Уровень | Код | Права |
|---------|-----|-------|
| **Нет доступа** | `none` | Нет прав на одобрение/отклонение. |
| **Чтение** | `read` | Просмотр поручений на согласовании (в рамках `banking` read). Действия одобрения/отклонения недоступны. |
| **Редактирование** | `edit` | Одобрение, отклонение, перенос даты, ручная отправка в банк. |

### Примечание

В текущей реализации `ERPSectionPermission` проверяет только раздел `banking` по URL. Раздел `banking_approve` определён в `ERP_SECTIONS` и может использоваться для более тонкой настройки (например, оператор с `banking: edit` без `banking_approve: edit` сможет создавать поручения, но не одобрять). Для полного разделения ролей требуется доработка permission-классов.

---

## 3. Назначение прав через модуль Персонал

### Шаги

1. Перейдите в **Настройки** → **Персонал**.
2. Выберите сотрудника или создайте нового.
3. В блоке **Права доступа ERP** найдите:
   - **Банковские операции** — выберите уровень: `Нет`, `Чтение` или `Редактирование`;
   - **Одобрение платежей** — выберите уровень: `Нет`, `Чтение` или `Редактирование`.
4. Сохраните.

### Структура erp_permissions

Права хранятся в JSON-поле `erp_permissions` модели `Employee`:

```json
{
  "objects": "edit",
  "payments": "edit",
  "banking": "edit",
  "banking_approve": "edit",
  "settings": "read"
}
```

### Особые случаи

- **Суперпользователь** (`is_superuser`) и **staff** — всегда полный доступ ко всем разделам;
- **Пользователь без привязанного Employee** — полный доступ (обратная совместимость).

---

## 4. Разделение ролей: оператор и контролёр

### Оператор (создаёт платёжные поручения)

**Рекомендуемые права:**

- `banking`: **edit** — создание поручений, просмотр выписок, синхронизация;
- `banking_approve`: **none** или **read** — если нужно запретить одобрение.

**Функции:**

- Загрузка и распознавание счетов;
- Создание платёжных поручений;
- Отправка на согласование;
- Просмотр выписок и сверка транзакций.

### Контролёр (одобряет платежи)

**Рекомендуемые права:**

- `banking`: **read** или **edit** — минимум read для просмотра поручений;
- `banking_approve`: **edit** — одобрение, отклонение, перенос даты, отправка в банк.

**Функции:**

- Одобрение/отклонение платёжных поручений;
- Перенос даты оплаты;
- Ручная отправка в банк;
- Просмотр истории действий.

### Универсальный сотрудник

- `banking`: **edit**
- `banking_approve`: **edit**

Может выполнять и создание, и одобрение платежей.

---

## Сводная таблица

| Роль | banking | banking_approve | Создание поручений | Одобрение | Отклонение | Перенос даты | Отправка в банк |
|------|---------|----------------|-------------------|-----------|------------|--------------|-----------------|
| Оператор | edit | none | ✓ | ✗ | ✗ | ✗ | ✗ |
| Контролёр | read | edit | ✗ | ✓ | ✓ | ✓ | ✓ |
| Универсал | edit | edit | ✓ | ✓ | ✓ | ✓ | ✓ |
| Только просмотр | read | read | ✗ | ✗ | ✗ | ✗ | ✗ |
