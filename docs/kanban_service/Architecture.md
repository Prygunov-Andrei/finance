# Kanban Service — Архитектура и безопасность (V1)

Дата: 2026-02-14

## Цели V1

- Две доски на одном ядре: `SupplyBoard` и `ObjectTasksBoard`.
- Ведение процесса (колонки/карточки/события/вложения/правила) в отдельном сервисе.
- Минимальный складской учет: движения `IN/OUT/ADJUST` + расчет остатков по локациям.
- Отрицательные остатки допускаются, но помечаются как `ahhtung` и триггерят уведомления.
- Уведомления хранятся централизованно в ERP (`core.Notification`).
- Файлы не копируются между частями системы: единый объектный стор (MinIO) + реестр файлов по `sha256`.
- Авторизация между сервисами: JWT RS256 (ERP подписывает, kanban проверяет) + сервисный токен для webhook.

## Границы ответственности

### ERP (источник истины)

- Объекты, договоры, контрагенты, каталог.
- Счета и оплата: `payments.Invoice`, статусный workflow и банковская интеграция.
- Уведомления пользователей: `core.Notification`.
- Вход пользователей и выдача JWT.

### Kanban Service (оркестрация процесса)

- Доски/колонки/карточки/события (append-only аудит).
- Вложения (файлы через File Registry).
- Rules engine lite (декларативные правила на события).
- Supply overlay: кейсы снабжения, поставки (частичные), привязки к ERP invoice.
- Склад V1: движения и остатки по локациям.

## Точки интеграции ERP ↔ Kanban

Kanban -> ERP (исходящие вызовы):
- Справочники: объекты/договоры/каталог (read-only).
- Счета: привязка/получение статуса `Invoice`.
- Уведомления: создание `core.Notification` (для supply/warehouse событий).

ERP -> Kanban (входящие вызовы):
- В будущем: события оплаты/изменения invoice (если нужно отражать в доске).

Принцип: никакого доступа к БД ERP напрямую, только через HTTP API и сервисные токены.

## Авторизация и права

### Пользовательская авторизация

- ERP выдает JWT с алгоритмом RS256.
- Kanban валидирует подпись публичным ключом.

Минимальные требования к токену:
- `iss` = фиксированная строка (например `finans-assistant-erp`)
- `aud` содержит `kanban-service`
- `exp`/`nbf` обязательны

### Service-to-service

- Отдельный заголовок `X-Service-Token: <KANBAN_SERVICE_TOKEN>` для webhook/сервисных вызовов.
- Сервисный токен не равен пользовательскому JWT.

### Роли (V1)

В kanban-сервисе роли трактуются независимо от UI, но должны соответствовать оргпроцессу:
- `supply_operator` — ведение кейса снабжения, привязка счетов, создание поставок.
- `warehouse` — создание движений склада, загрузка первички.
- `accountant` — просмотр первички, пере-привязка документов (если разрешено), контроль.
- `director` — просмотр (в V1 без права менять финансы).
- `admin` — настройка досок/колонок/правил.

Примечание: ERP уже имеет модель прав `Employee.erp_permissions` (см. `backend/personnel/models.py`). Для V1 мы используем соответствие на уровне UI, но контроль доступа в kanban не должен зависеть от фронта.

## Файлы без копий (MinIO + File Registry)

Цель: файл загружается один раз, дальше в любых сущностях фигурирует только ссылка (`file_id`).

### Хранилище

- MinIO bucket(и), доступ только по signed URL.
- Объектный ключ контент-адресный: `sha256/<first2>/<sha256>`.

### File Registry

Храним:
- `sha256` (unique)
- `size_bytes`
- `mime_type`
- `original_filename`
- `bucket` + `object_key`
- `created_by` + `created_at`
- ACL (минимум: владелец и scope доски/карточки)

### Upload workflow

1) `POST /files/init` -> presigned PUT URL + предполагаемый object_key
2) клиент загружает файл напрямую в MinIO
3) `POST /files/finalize` (sha256, size, key) -> регистрация/дедуп

### Download workflow

`POST /files/{id}/download_url` -> presigned GET URL (TTL 1-10 минут)

## Threat model (короткий) и меры

### 1) Утечки файлов

Риски:
- подбор прямых URL
- повторное использование signed URL

Меры:
- только presigned URL с коротким TTL
- запрет public buckets
- проверка прав при выдаче presigned GET
- audit лог выдачи ссылок

### 2) Replay webhooks / повторные события

Риски:
- повторное создание уведомлений/движений

Меры:
- идемпотентность по `event_id`/`request_id`
- запись "обработано" (dedup table)
- подпись webhook payload (HMAC) или сервисный токен + timestamp

### 3) DOS на upload/move/stock

Меры:
- rate limit на nginx для upload/move
- лимиты размера файлов и allowlist mime
- пагинация и ограничения выборок

### 4) Эскалация прав

Меры:
- строгий RBAC на endpoints
- server-side валидация: нельзя создавать `ADJUST` без причины
- полная трассировка "кто что сделал" через `CardEvent`/`StockMove` audit

### 5) Инъекции/вредоносные файлы

Меры:
- allowlist типов
- опциональный AV-hook (V2), но интерфейс (состояние проверки файла) заложить в модели

